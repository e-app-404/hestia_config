#═════════════════════════════════════════════════════════════════════════════
# ▶ LOGIC SENSOR: MOTION & RECENT MOTION WITH DELAY_OFF ◀
# Loader: !include_dir_merge_list domain/templates/
# Schema: binary_sensor (list)
# Tier: β  •  Domain: logic  •  Updated: 2025-10-06
# Notes:
#   • Motion aggregation uses motion-only sources (occupancy removed).
#   • Non-motion inputs (vibration/contact) are allowed via proxies.
#   • Provenance fields (upstream_sources/downstream_consumers) are JSON arrays.
#═════════════════════════════════════════════════════════════════════════════

- binary_sensor:

    # ───────────────────────────── BEDROOM / SANCTUM ─────────────────────────
    - name: "Bedroom Motion (Beta)"
      unique_id: "bedroom_motion_beta"
      device_class: motion
      state: |
        {% from 'template.library.jinja' import preference_select %}
        {% set sources = [
          {'entity': 'binary_sensor.sanctum_motion_alpha',              'protocol': 'tplink', 'preference': 1, 'type': 'motion'},
          {'entity': 'binary_sensor.wardrobe_motion_beta',              'protocol': 'tplink', 'preference': 2, 'type': 'motion'},
          {'entity': 'binary_sensor.bedroom_security_cam_alpha_motion', 'protocol': 'wifi',   'preference': 3, 'type': 'motion'},
          {'entity': 'binary_sensor.bedroom_ottoman_motion_proxy',      'protocol': 'proxy',  'preference': 4, 'type': 'vibration'}
        ] %}
        {{ preference_select(sources) == 'on' }}
      attributes:
        tier: "β"
        canonical_id: "bedroom_motion_β"
        subsystem: "hermes"
        module: "motion"
        type: "preference_proxy"
        role: "beta_motion"
        file: "/config/domain/templates/motion_logic.yaml"
        protocols: "TP-Link(1,2), Wi-Fi(3)"
        upstream_sources: >
          {{ [
            'template.library.jinja',
            'binary_sensor.sanctum_motion_alpha',
            'binary_sensor.wardrobe_motion_beta',
            'binary_sensor.bedroom_security_cam_alpha_motion',
            'binary_sensor.bedroom_ottoman_motion_proxy'
          ] | tojson }}
        aggregation_strategy: "preference-based selection (motion-only)"
        active_source: >
          {% from 'template.library.jinja' import get_active_source %}
          {% set sources = [
            {'entity': 'binary_sensor.sanctum_motion_alpha','preference': 1},
            {'entity': 'binary_sensor.wardrobe_motion_beta','preference': 2},
            {'entity': 'binary_sensor.bedroom_security_cam_alpha_motion','preference': 3},
            {'entity': 'binary_sensor.bedroom_ottoman_motion_proxy','preference': 4}
          ] %}
          {{ get_active_source(sources) }}
        source_count: "4"
        version: "2.5"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "bedroom"

    - name: "Ensuite Motion (Beta)"
      unique_id: "ensuite_motion_beta"
      device_class: motion
      state: |
        {% from 'template.library.jinja' import preference_select %}
        {% set sources = [
          {'entity': 'binary_sensor.ensuite_motion_real_time', 'protocol': 'mqtt', 'preference': 1, 'type': 'motion'}
        ] %}
        {{ preference_select(sources) == 'on' }}
      attributes:
        tier: "β"
        canonical_id: "ensuite_motion_β"
        subsystem: "hermes"
        module: "motion"
        type: "preference_proxy"
        role: "beta_motion"
        file: "/config/domain/templates/motion_logic.yaml"
        protocols: "MQTT(1)"
        upstream_sources: >
          {{ ['template.library.jinja','binary_sensor.ensuite_motion_real_time'] | tojson }}
        aggregation_strategy: "preference-based selection (motion-only)"
        active_source: >
          {% from 'template.library.jinja' import get_active_source %}
          {% set sources = [
            {'entity': 'binary_sensor.ensuite_motion_real_time','preference': 1}
          ] %}
          {{ get_active_source(sources) }}
        source_count: "1"
        version: "2.5"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "ensuite"

    - name: "Wardrobe Motion (Beta)"
      unique_id: "wardrobe_motion_beta"
      device_class: motion
      state: |
        {% from 'template.library.jinja' import preference_select %}
        {% set sources = [
          {'entity': 'binary_sensor.bedroom_wardrobe_motion_alpha_motion', 'protocol': 'tplink', 'preference': 1, 'type': 'motion'}
        ] %}
        {{ preference_select(sources) == 'on' }}
      attributes:
        tier: "β"
        canonical_id: "wardrobe_motion_β"
        subsystem: "hermes"
        module: "motion"
        type: "preference_proxy"
        role: "beta_motion"
        file: "/config/domain/templates/motion_logic.yaml"
        protocols: "TP-Link(1)"
        upstream_sources: >
          {{ ['template.library.jinja','binary_sensor.bedroom_wardrobe_motion_alpha_motion'] | tojson }}
        aggregation_strategy: "preference-based selection (motion-only)"
        active_source: >
          {% from 'template.library.jinja' import get_active_source %}
          {% set sources = [
            {'entity': 'binary_sensor.bedroom_wardrobe_motion_alpha_motion','preference': 1}
          ] %}
          {{ get_active_source(sources) }}
        source_count: "1"
        version: "2.3"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "bedroom"
        subarea: "wardrobe"

    - name: "Sanctum Motion (Beta)"
      unique_id: "sanctum_motion_beta"
      device_class: motion
      state: |
        {% from 'template.library.jinja' import preference_select %}
        {% set sources = [
          {'entity': 'binary_sensor.sanctum_motion_alpha', 'protocol': 'tplink', 'preference': 1, 'type': 'motion'},
          {'entity': 'binary_sensor.bedroom_motion_beta',  'protocol': 'beta',   'preference': 2, 'type': 'motion'},
          {'entity': 'binary_sensor.ensuite_motion_beta',  'protocol': 'beta',   'preference': 3, 'type': 'motion'}
        ] %}
        {{ preference_select(sources) == 'on' }}
      attributes:
        tier: "β"
        canonical_id: "sanctum_motion_β"
        subsystem: "hermes"
        module: "motion"
        type: "preference_proxy"
        role: "beta_motion"
        file: "/config/domain/templates/motion_logic.yaml"
        protocols: "TP-Link(1), Beta(2,3)"
        upstream_sources: >
          {{ ['template.library.jinja','binary_sensor.sanctum_motion_alpha','binary_sensor.bedroom_motion_beta','binary_sensor.ensuite_motion_beta'] | tojson }}
        aggregation_strategy: "preference-based selection (motion-only)"
        active_source: >
          {% from 'template.library.jinja' import get_active_source %}
          {% set sources = [
            {'entity': 'binary_sensor.sanctum_motion_alpha','preference': 1},
            {'entity': 'binary_sensor.bedroom_motion_beta','preference': 2},
            {'entity': 'binary_sensor.ensuite_motion_beta','preference': 3}
          ] %}
          {{ get_active_source(sources) }}
        source_count: "3"
        version: "1.1"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "sanctum"

    # ───────────────────────────────── HALLWAYS ──────────────────────────────
    - name: "Hallway Downstairs Motion (Beta)"
      unique_id: "hallway_downstairs_motion_beta"
      device_class: motion
      state: |
        {% from 'template.library.jinja' import preference_select %}
        {% set sources = [
          {'entity': 'binary_sensor.downstairs_motion_alpha_motion', 'protocol': 'tplink', 'preference': 1, 'type': 'motion'},
          {'entity': 'binary_sensor.entrance_motion_proxy',          'protocol': 'proxy',  'preference': 2, 'type': 'contact'}
        ] %}
        {{ preference_select(sources) == 'on' }}
      attributes:
        tier: "β"
        canonical_id: "hallway_downstairs_motion_β"
        subsystem: "hermes"
        module: "motion"
        type: "preference_proxy"
        role: "beta_motion"
        file: "/config/domain/templates/motion_logic.yaml"
        protocols: "TP-Link(1), Proxy(2)"
        upstream_sources: >
          {{ ['template.library.jinja','binary_sensor.downstairs_motion_alpha_motion','binary_sensor.entrance_motion_proxy'] | tojson }}
        aggregation_strategy: "preference-based selection (motion-only)"
        active_source: >
          {% from 'template.library.jinja' import get_active_source %}
          {% set sources = [
            {'entity': 'binary_sensor.downstairs_motion_alpha_motion','preference': 1},
            {'entity': 'binary_sensor.entrance_motion_proxy','preference': 2}
          ] %}
          {{ get_active_source(sources) }}
        source_count: "2"
        version: "2.3"
        last_updated: "2025-10-06"
        floor_id: "downstairs"
        area_id: "hallway"
        subarea: "downstairs"

    - name: "Hallway Upstairs Motion (Beta)"
      unique_id: "hallway_upstairs_motion_beta"
      device_class: motion
      state: |
        {% from 'template.library.jinja' import preference_select %}
        {% set sources = [
          {'entity': 'binary_sensor.upstairs_motion_alpha_motion', 'protocol': 'tplink', 'preference': 1, 'type': 'motion'}
        ] %}
        {{ preference_select(sources) == 'on' }}
      attributes:
        tier: "β"
        canonical_id: "hallway_upstairs_motion_β"
        subsystem: "hermes"
        module: "motion"
        type: "preference_proxy"
        role: "beta_motion"
        file: "/config/domain/templates/motion_logic.yaml"
        protocols: "TP-Link(1)"
        upstream_sources: >
          {{ ['template.library.jinja','binary_sensor.upstairs_motion_alpha_motion'] | tojson }}
        aggregation_strategy: "preference-based selection (motion-only)"
        active_source: >
          {% from 'template.library.jinja' import get_active_source %}
          {% set sources = [
            {'entity': 'binary_sensor.upstairs_motion_alpha_motion','preference': 1}
          ] %}
          {{ get_active_source(sources) }}
        source_count: "1"
        version: "2.3"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "hallway"
        subarea: "upstairs"

    # ───────────────────────────────── KITCHEN / LIVING ─────────────────────
    - name: "Kitchen Motion (Beta)"
      unique_id: "kitchen_motion_beta"
      device_class: motion
      state: |
        {% from 'template.library.jinja' import preference_select %}
        {% set sources = [
          {'entity': 'binary_sensor.kitchen_motion_alpha_motion', 'protocol': 'tplink', 'preference': 1, 'type': 'motion'}
        ] %}
        {{ preference_select(sources) == 'on' }}
      attributes:
        tier: "β"
        canonical_id: "kitchen_motion_β"
        subsystem: "hermes"
        module: "motion"
        type: "preference_proxy"
        role: "beta_motion"
        file: "/config/domain/templates/motion_logic.yaml"
        protocols: "TP-Link(1)"
        upstream_sources: >
          {{ ['template.library.jinja','binary_sensor.kitchen_motion_alpha_motion'] | tojson }}
        aggregation_strategy: "preference-based selection (motion-only)"
        active_source: >
          {% from 'template.library.jinja' import get_active_source %}
          {% set sources = [
            {'entity': 'binary_sensor.kitchen_motion_alpha_motion','preference': 1}
          ] %}
          {{ get_active_source(sources) }}
        source_count: "1"
        version: "2.3"
        last_updated: "2025-10-06"
        floor_id: "downstairs"
        area_id: "kitchen"

    - name: "Living Room Motion (Beta)"
      unique_id: "living_room_motion_beta"
      device_class: motion
      state: |
        {% from 'template.library.jinja' import preference_select %}
        {% set sources = [
          {'entity': 'binary_sensor.living_room_multipurpose_alpha_motion', 'protocol': 'smartthings', 'preference': 1, 'type': 'motion'}
        ] %}
        {{ preference_select(sources) == 'on' }}
      attributes:
        tier: "β"
        canonical_id: "living_room_motion_β"
        subsystem: "hermes"
        module: "motion"
        type: "preference_proxy"
        role: "beta_motion"
        file: "/config/domain/templates/motion_logic.yaml"
        protocols: "SmartThings(1)"
        upstream_sources: >
          {{ ['template.library.jinja','binary_sensor.living_room_multipurpose_alpha_motion'] | tojson }}
        aggregation_strategy: "preference-based selection (motion-only)"
        active_source: >
          {% from 'template.library.jinja' import get_active_source %}
          {% set sources = [
            {'entity': 'binary_sensor.living_room_multipurpose_alpha_motion','preference': 1}
          ] %}
          {{ get_active_source(sources) }}
        source_count: "1"
        version: "2.3"
        last_updated: "2025-10-06"
        floor_id: "downstairs"
        area_id: "living_room"

    # ─────────────────────────────────── PROXIES ────────────────────────────
    - name: "Bedroom Ottoman Motion (Proxy)"
      unique_id: bedroom_ottoman_motion_proxy
      device_class: motion
      delay_off:
        seconds: 45
      state: >-
        {{ is_state('binary_sensor.bedroom_ottoman_alpha_vibration','on')
           or is_state('binary_sensor.bedroom_ottoman_alpha_vibration','detected') }}
      availability: >-
        {{ states('binary_sensor.bedroom_ottoman_alpha_vibration') not in ['unknown','unavailable', none, ''] }}
      icon: "mdi:vibrate"
      attributes:
        tier: "β"
        canonical_id: "bedroom_ottoman_motion_proxy_β"
        subsystem: "hermes"
        module: "motion"
        type: "proxy"
        role: "motion_via_vibration"
        file: "/config/domain/templates/motion_logic.yaml"
        upstream_sources: >
          {{ ['binary_sensor.bedroom_ottoman_alpha_vibration'] | tojson }}
        downstream_consumers: >
          {{ ['binary_sensor.bedroom_motion_beta','binary_sensor.bedroom_motion_recent_beta','sensor.bedroom_last_activity','hestia.config.devices.motion_index'] | tojson }}
        aggregation_strategy: "vibration→motion pulse"
        source_count: "1"
        version: "1.1"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "bedroom"
        subarea: "ottoman"

    - name: "Entrance Motion (Proxy)"
      unique_id: "entrance_motion_proxy"
      device_class: motion
      delay_off:
        seconds: 5
      state: >-
        {{ is_state('binary_sensor.entrance_door_contact_alpha_matter_door','on')
           or is_state('binary_sensor.entrance_door_contact_alpha_matter_door','open')
           or is_state('binary_sensor.entrance_door_contact_alpha_door','on')
           or is_state('binary_sensor.entrance_door_contact_alpha_door','open') }}
      availability: >-
        {{ states('binary_sensor.entrance_door_contact_alpha_matter_door') not in ['unknown','unavailable', none, '']
           or states('binary_sensor.entrance_door_contact_alpha_door') not in ['unknown','unavailable', none, ''] }}
      attributes:
        tier: "β"
        canonical_id: "entrance_motion_proxy_β"
        subsystem: "hermes"
        module: "motion"
        type: "proxy"
        role: "motion_via_contact"
        file: "/config/domain/templates/motion_logic.yaml"
        upstream_sources: >
          {{ ['binary_sensor.entrance_door_contact_alpha_matter_door','binary_sensor.entrance_door_contact_alpha_door'] | tojson }}
        downstream_consumers: >
          {{ ['binary_sensor.hallway_downstairs_motion_beta','binary_sensor.hallway_downstairs_motion_recent_beta','sensor.hallway_downstairs_last_activity','hestia.config.devices.motion_index'] | tojson }}
        aggregation_strategy: "contact→motion pulse"
        source_count: "2"
        version: "1.1"
        last_updated: "2025-10-06"
        floor_id: "downstairs"
        area_id: "entrance"

    # ───────────────────────────── RECENT (delay_off) WRAPPERS ──────────────
    - name: "Bedroom Motion Recent (Beta)"
      unique_id: "bedroom_motion_recent_beta"
      device_class: motion
      delay_off:
        minutes: 5
      state: "{{ is_state('binary_sensor.bedroom_motion_beta','on') }}"
      attributes:
        tier: "β"
        canonical_id: "bedroom_motion_recent_β"
        subsystem: "hermes"
        module: "motion"
        type: "delay_proxy"
        role: "motion_timeout"
        file: "/config/domain/templates/motion_logic.yaml"
        delay_duration: "300s"
        timeout_behavior: "delay_off"
        upstream_sources: >
          {{ ['binary_sensor.bedroom_motion_beta'] | tojson }}
        downstream_consumers: >
          {{ ['binary_sensor.bedroom_occupancy_beta','sensor.bedroom_motion_score_gamma'] | tojson }}
        aggregation_strategy: "timeout-based extension"
        version: "2.4"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "bedroom"

    - name: "Kitchen Motion Recent (Beta)"
      unique_id: kitchen_motion_recent_beta
      device_class: motion
      delay_off:
        minutes: 5
      state: "{{ is_state('binary_sensor.kitchen_motion_beta','on') }}"
      attributes:
        tier: "β"
        canonical_id: "kitchen_motion_recent_β"
        subsystem: "hermes"
        module: "motion"
        type: "delay_proxy"
        role: "motion_timeout"
        file: "/config/domain/templates/motion_logic.yaml"
        delay_duration: "300s"
        timeout_behavior: "delay_off"
        upstream_sources: >
          {{ ['binary_sensor.kitchen_motion_beta'] | tojson }}
        downstream_consumers: >
          {{ ['binary_sensor.kitchen_occupancy_beta','sensor.kitchen_motion_score_gamma'] | tojson }}
        version: "2.2"
        last_updated: "2025-10-06"
        floor_id: "downstairs"
        area_id: "kitchen"

    - name: "Living Room Motion Recent (Beta)"
      unique_id: living_room_motion_recent_beta
      device_class: motion
      delay_off:
        minutes: 5
      state: "{{ is_state('binary_sensor.living_room_motion_beta','on') }}"
      attributes:
        tier: "β"
        canonical_id: "living_room_motion_recent_β"
        subsystem: "hermes"
        module: "motion"
        type: "delay_proxy"
        role: "motion_timeout"
        file: "/config/domain/templates/motion_logic.yaml"
        delay_duration: "300s"
        timeout_behavior: "delay_off"
        upstream_sources: >
          {{ ['binary_sensor.living_room_motion_beta'] | tojson }}
        downstream_consumers: >
          {{ ['binary_sensor.living_room_occupancy_beta','sensor.living_room_motion_score_gamma'] | tojson }}
        version: "2.2"
        last_updated: "2025-10-06"
        floor_id: "downstairs"
        area_id: "living_room"

    - name: "Ensuite Motion Recent (Beta)"
      unique_id: ensuite_motion_recent_beta
      device_class: motion
      delay_off:
        minutes: 5
      state: "{{ is_state('binary_sensor.ensuite_motion_beta','on') }}"
      attributes:
        tier: "β"
        canonical_id: "ensuite_motion_recent_β"
        subsystem: "hermes"
        module: "motion"
        type: "delay_proxy"
        role: "motion_timeout"
        file: "/config/domain/templates/motion_logic.yaml"
        delay_duration: "300s"
        timeout_behavior: "delay_off"
        upstream_sources: >
          {{ ['binary_sensor.ensuite_motion_beta'] | tojson }}
        downstream_consumers: >
          {{ ['binary_sensor.ensuite_occupancy_beta','sensor.ensuite_motion_score_gamma'] | tojson }}
        version: "2.4"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "ensuite"

    - name: "Hallway Downstairs Motion Recent (Beta)"
      unique_id: hallway_downstairs_motion_recent_beta
      device_class: motion
      delay_off:
        minutes: 5
      state: "{{ is_state('binary_sensor.hallway_downstairs_motion_beta','on') }}"
      attributes:
        tier: "β"
        canonical_id: "hallway_downstairs_motion_recent_β"
        subsystem: "hermes"
        module: "motion"
        type: "delay_proxy"
        role: "motion_timeout"
        file: "/config/domain/templates/motion_logic.yaml"
        delay_duration: "300s"
        timeout_behavior: "delay_off"
        upstream_sources: >
          {{ ['binary_sensor.hallway_downstairs_motion_beta'] | tojson }}
        downstream_consumers: >
          {{ ['binary_sensor.hallway_downstairs_occupancy_beta','sensor.hallway_downstairs_motion_score_gamma'] | tojson }}
        version: "2.2"
        last_updated: "2025-10-06"
        floor_id: "downstairs"
        area_id: "hallway"
        subarea: "downstairs"

    - name: "Hallway Upstairs Motion Recent (Beta)"
      unique_id: hallway_upstairs_motion_recent_beta
      device_class: motion
      delay_off:
        seconds: 20
      state: "{{ is_state('binary_sensor.hallway_upstairs_motion_beta','on') }}"
      attributes:
        tier: "β"
        canonical_id: "hallway_upstairs_motion_recent_β"
        subsystem: "hermes"
        module: "motion"
        type: "delay_proxy"
        role: "motion_timeout"
        file: "/config/domain/templates/motion_logic.yaml"
        delay_duration: "20s"
        timeout_behavior: "delay_off"
        upstream_sources: >
          {{ ['binary_sensor.hallway_upstairs_motion_beta'] | tojson }}
        downstream_consumers: >
          {{ ['binary_sensor.hallway_upstairs_occupancy_beta','sensor.hallway_upstairs_motion_score_gamma'] | tojson }}
        version: "2.2"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "hallway"
        subarea: "upstairs"

    - name: "Wardrobe Motion Recent (Beta)"
      unique_id: wardrobe_motion_recent_beta
      device_class: motion
      delay_off:
        minutes: 2
      state: "{{ is_state('binary_sensor.wardrobe_motion_beta','on') }}"
      attributes:
        tier: "β"
        canonical_id: "wardrobe_motion_recent_β"
        subsystem: "hermes"
        module: "motion"
        type: "delay_proxy"
        role: "motion_timeout"
        file: "/config/domain/templates/motion_logic.yaml"
        delay_duration: "120s"
        timeout_behavior: "delay_off"
        upstream_sources: >
          {{ ['binary_sensor.wardrobe_motion_beta'] | tojson }}
        downstream_consumers: >
          {{ ['binary_sensor.wardrobe_occupancy_beta','sensor.wardrobe_motion_score_gamma'] | tojson }}
        version: "2.2"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "bedroom"
        subarea: "wardrobe"

    - name: "Sanctum Motion Recent (Beta)"
      unique_id: sanctum_motion_recent_beta
      device_class: motion
      delay_off:
        minutes: 5
      state: "{{ is_state('binary_sensor.sanctum_motion_beta','on') }}"
      attributes:
        tier: "β"
        canonical_id: "sanctum_motion_recent_β"
        subsystem: "hermes"
        module: "motion"
        type: "delay_proxy"
        role: "motion_timeout"
        file: "/config/domain/templates/motion_logic.yaml"
        delay_duration: "300s"
        timeout_behavior: "delay_off"
        upstream_sources: >
          {{ ['binary_sensor.sanctum_motion_beta'] | tojson }}
        downstream_consumers: >
          {{ ['binary_sensor.sanctum_occupancy_beta','sensor.sanctum_motion_score_gamma'] | tojson }}
        version: "1.1"
        last_updated: "2025-10-06"
        floor_id: "upstairs"
        area_id: "sanctum"
