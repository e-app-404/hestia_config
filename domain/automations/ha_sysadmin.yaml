# 1. Record Home Assistant restart time
- id: record_ha_restart_time
  alias: "Record HA Restart Time"
  description: "Updates input_datetime helper with the exact restart time on Home Assistant startup."
  mode: single
  trigger:
    - platform: homeassistant
      event: start
  action:
    - action: input_datetime.set_datetime
      target:
        entity_id: input_datetime.last_ha_restart
      data:
        datetime: "{{ now().strftime('%Y-%m-%d %H:%M:%S') }}"

# 2. Notify and set media state on Home Assistant start
- id: d2d8775b-e666-4fb4-976d-02b4d9c5a396
  alias: Home Assistant Start - Notify
  description: "Notify all users when HA starts."
  mode: single
  trigger:
    - platform: homeassistant
      event: start
  action:
    - alias: Startup notification
      action: script.notify_engine
      continue_on_error: true
      data:
        who: "evert"
        title: "HA started"
        value1: "Home Assistant started at {{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        group: ha
        tag_id: "information"
        importance_id: default
        color: "green"
        sticky: false
        timeout_sec: 300

    - action: tts.speak
      target:
        entity_id:
          - tts.google_translate_en_com
      data:
        cache: true
        media_player_entity_id: media_player.bedroom_google_home_mini_speaker
        message: "Home Assistant successfully rebooted."
        language: en-ca

# 3. Count Home Assistant errors and warnings
- id: c057ca2c-ab20-4fe0-a32b-5980c0990fb2
  alias: "Count Home Assistant errors"
  description: "Counts errors and warnings from Home Assistant system log."
  mode: queued
  max: 20
  max_exceeded: silent
  trigger:
    - platform: event
      event_type: system_log_event
      event_data:
        level: ERROR
      id: error
    - platform: event
      event_type: system_log_event
      event_data:
        level: WARNING
      id: warning
  action:
    - choose:
        - conditions:
            - condition: trigger
              id: warning
          sequence:
            - action: counter.increment
              target:
                entity_id: counter.homeassistant_warnings
        - conditions:
            - condition: trigger
              id: error
          sequence:
            - action: counter.increment
              target:
                entity_id: counter.homeassistant_errors

# 4. Notify on Home Assistant shutdown
- id: 2a93d8c4-5ad7-4bf3-842c-2b0940efe4a2
  alias: Home Assistant Shutdown - Notify
  description: "Notify Evert when HA is shutting down."
  mode: single
  trigger:
    - platform: homeassistant
      event: shutdown
  action:
    - alias: Shutdown notification
      action: script.notify_engine
      data:
        who: "evert"
        title: "HA shutdown"
        value1: "Home Assistant shutting down at {{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        group: ha
        tag_id: "information"
        importance_id: default
        color: "green"
        sticky: false
        timeout_sec: 180

    - action: tts.speak
      target:
        entity_id:
          - tts.google_translate_en_com
      data:
        cache: true
        media_player_entity_id: media_player.bedroom_google_home_mini_speaker
        message: "Home Assistant will shut down at {{ now().strftime('%Y-%m-%d %H:%M:%S') }}"
        language: en-ca
