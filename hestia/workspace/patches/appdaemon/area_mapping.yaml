# Area Mapping v3.1 — Activity Tracker, Valetudo, Motion Lighting
# Enriched: Spatial hierarchy and parent/child relationships from area_hierarchy contract
# Consolidated: All vacuum segment_id in node capabilities (no redundant sections)
# Canonical IDs align with Home Assistant registry

metadata:
  version: "3.1"
  last_updated: "2025-10-18"
  contract_source: "canonical/support/contracts/area_hierarchy.yaml"
  description: |
    Canonical area definitions for room_db activity tracking, motion lighting, and vacuum control.
    Hierarchy reflects physical containment and spatial relationships for inference propagation.
  valid_rooms:
    - bedroom
    - ensuite
    - kitchen
    - living_room
    - downstairs
    - upstairs
    - entrance
    - powder_room
    - desk
    - wardrobe
    - laundry_room

# ══════════════════════════════════════════════════════════════════
# PHYSICAL AREAS (Main Rooms)
# ══════════════════════════════════════════════════════════════════

nodes:
  # ────────────────────────────────────────────────────────────────
  # Sanctum Floor (Upstairs Private Zone)
  # ────────────────────────────────────────────────────────────────
  
  - id: bedroom
    type: area
    canonical_name: "Bedroom"
    parents: [sanctum]
    floor_id: sanctum
    container: ["area", "bedroom", "Bedroom"]
    description: "Master bedroom - primary sleeping area"
    capabilities:
      motion_lighting:
        timeout: 120
        illuminance_threshold: 10
    children: [desk, wardrobe, ottoman, hifi_configuration]
    tags: [private, sleeping, sanctum]
    devices: 66
    entities: 7

  - id: ensuite
    type: area
    canonical_name: "Ensuite"
    parents: [sanctum]
    floor_id: sanctum
    container: ["area", "ensuite", "Ensuite"]
    description: "Ensuite bathroom attached to bedroom"
    capabilities:
      motion_lighting:
        timeout: 120
        illuminance_threshold: 5
    tags: [private, bathroom, sanctum]
    devices: 16
    entities: 4

  # ────────────────────────────────────────────────────────────────
  # Downstairs Floor (Ground Level)
  # ────────────────────────────────────────────────────────────────

  - id: kitchen
    type: area
    canonical_name: "Kitchen"
    parents: [downstairs]
    floor_id: downstairs
    container: ["area", "kitchen", "Kitchen"]
    description: "Kitchen and dining area"
    capabilities:
      motion_lighting:
        timeout: 300
        illuminance_threshold: 10
      vacuum_control:
        segment_id: 17
        default_mode: "deep"
        cleaning_frequency_days: 3
        activity_threshold_hours: 12
    children: [laundry_room]
    tags: [downstairs, shared, food_prep]
    devices: 18
    entities: 4

  - id: living_room
    type: area
    canonical_name: "Living Room"
    parents: [downstairs]
    floor_id: downstairs
    container: ["area", "living_room", "Living Room"]
    description: "Main living room for entertainment and relaxation"
    capabilities:
      motion_lighting:
        timeout: 240
        illuminance_threshold: 8
      vacuum_control:
        segment_id: 19
        default_mode: "standard"
        cleaning_frequency_days: 3
        activity_threshold_hours: 24
    tags: [downstairs, shared, entertainment]
    devices: 25
    entities: 5

  - id: powder_room
    type: area
    canonical_name: "Powder Room"
    parents: [downstairs]
    floor_id: downstairs
    container: ["area", "powder_room", "powder room"]
    description: "Downstairs guest bathroom"
    capabilities:
      vacuum_control:
        segment_id: 20
        default_mode: "standard"
        cleaning_frequency_days: 7
        activity_threshold_hours: 48
    tags: [downstairs, bathroom, guest]
    devices: 0
    entities: 0

  - id: entrance
    type: subarea
    canonical_name: "Entrance"
    parents: [downstairs]
    floor_id: downstairs
    container: ["area", "entrance", "Entrance"]
    description: "Front entrance area (door contact motion proxy)"
    capabilities:
      motion_lighting:
        timeout: 120
        illuminance_threshold: 15
    tags: [downstairs, entry, transit]
    devices: 5
    entities: 3
    notes: "Uses binary_sensor.entrance_motion_beta (door contact proxy)"

  # ────────────────────────────────────────────────────────────────
  # Hallway System (Transit Connectors)
  # ────────────────────────────────────────────────────────────────

  - id: downstairs
    type: area
    canonical_name: "Hallway (Downstairs)"
    parents: [hallway]
    floor_id: downstairs
    container: ["area", "downstairs", "Downstairs"]
    description: "Main hallway downstairs - ground floor circulation"
    capabilities:
      motion_lighting:
        timeout: 240
        illuminance_threshold: 15
      vacuum_control:
        segment_id: 18
        default_mode: "standard"
        cleaning_frequency_days: 3
        activity_threshold_hours: 24
    children: [entrance, kitchen, living_room, powder_room]
    tags: [hallway, transit, downstairs]
    devices: 5
    entities: 4
    propagation:
      motion_from_children: probable
      occupancy_aggregate: weighted_sum

  - id: upstairs
    type: area
    canonical_name: "Upstairs"
    parents: [hallway]
    floor_id: sanctum
    container: ["area", "upstairs", "upstairs"]
    description: "Upstairs hallway - upper floor circulation"
    capabilities:
      motion_lighting:
        timeout: 180
        illuminance_threshold: 12
    children: [bedroom, ensuite]
    tags: [hallway, transit, upstairs, sanctum]
    devices: 5
    entities: 5
    propagation:
      motion_from_children: probable
      occupancy_aggregate: weighted_sum

  # ────────────────────────────────────────────────────────────────
  # Subareas (Contained within Primary Areas)
  # ────────────────────────────────────────────────────────────────

  - id: desk
    type: subarea
    canonical_name: "Desk"
    parents: [bedroom]
    floor_id: sanctum
    container: ["area", "desk", "Desk"]
    description: "Desk area within bedroom for work/study"
    capabilities:
      motion_lighting:
        timeout: 300
        illuminance_threshold: 20
    tags: [subarea, workspace, bedroom, sanctum]
    devices: 20
    entities: 0
    propagation:
      motion_to_parent: probable
      occupancy_to_parent: possible

  - id: wardrobe
    type: subarea
    canonical_name: "Wardrobe"
    parents: [bedroom]
    floor_id: sanctum
    container: ["area", "wardrobe", "Wardrobe"]
    description: "Wardrobe closet within bedroom"
    capabilities:
      motion_lighting:
        timeout: 120
        illuminance_threshold: 10
    tags: [subarea, storage, bedroom, sanctum]
    devices: 4
    entities: 2
    propagation:
      motion_to_parent: probable
      occupancy_to_parent: rare

  - id: ottoman
    type: subarea
    canonical_name: "Ottoman"
    parents: [bedroom]
    floor_id: sanctum
    container: ["area", "ottoman", "Ottoman"]
    description: "Ottoman storage area in bedroom"
    tags: [subarea, storage, bedroom, sanctum]
    devices: 1
    entities: 0
    notes: "Under-bed storage with vibration sensor"

  - id: hifi_configuration
    type: subarea
    canonical_name: "HiFi Configuration"
    parents: [bedroom]
    floor_id: sanctum
    container: ["area", "hifi_configuration", "hifi configuration"]
    description: "Audio system configuration area"
    tags: [subarea, media, bedroom, sanctum]
    devices: 0
    entities: 0

  - id: laundry_room
    type: subarea
    canonical_name: "Laundry Room"
    parents: [kitchen]
    floor_id: downstairs
    container: ["area", "laundry_room", "Laundry room"]
    description: "Laundry and utility room (adjacent to kitchen)"
    capabilities:
      vacuum_control:
        segment_id: 16
        default_mode: "standard"
        cleaning_frequency_days: 7
        activity_threshold_hours: 72
    tags: [subarea, utility, downstairs]
    devices: 2
    entities: 0

# ══════════════════════════════════════════════════════════════════
# INFERENCE & PROPAGATION RULES
# ══════════════════════════════════════════════════════════════════

propagation_rules:
  motion:
    from_subarea_to_area: probable        # desk → bedroom
    from_area_to_subarea: improbable      # bedroom → desk
    from_area_to_container: probable      # bedroom → sanctum
    transient_decay: true
    decay_rate: 0.7
    
  presence:
    from_subarea_to_area: possible
    from_area_to_subarea: rare
    memory: sticky                         # Higher retention than motion
    
  occupancy:
    aggregate_method: weighted_sum
    weights:
      subarea: 0.6
      area: 1.0
      container: 0.4
    decay_profile:
      subarea_timeout: 2m
      area_timeout: 5m
      container_timeout: 10m

# ══════════════════════════════════════════════════════════════════
# VACUUM SEGMENT SUMMARY (Derived from Capabilities)
# ══════════════════════════════════════════════════════════════════

vacuum_summary:
  enabled_rooms: 5
  total_segments: 5
  segments:
    - room: kitchen
      segment_id: 17
      mode: deep
      frequency_days: 3
    - room: living_room
      segment_id: 19
      mode: standard
      frequency_days: 3
    - room: downstairs
      segment_id: 18
      mode: standard
      frequency_days: 3
    - room: powder_room
      segment_id: 20
      mode: standard
      frequency_days: 7
    - room: laundry_room
      segment_id: 16
      mode: standard
      frequency_days: 7

# ══════════════════════════════════════════════════════════════════
# SPATIAL HIERARCHY TREE (Visual Reference)
# ══════════════════════════════════════════════════════════════════

hierarchy_tree: |
  home
  ├── hallway (structural connector)
  │   ├── downstairs (floor: downstairs)
  │   │   ├── entrance*
  │   │   ├── kitchen
  │   │   │   └── laundry_room*
  │   │   ├── living_room
  │   │   └── powder_room
  │   └── upstairs (floor: sanctum)
  │       └── sanctum
  │           ├── bedroom
  │           │   ├── desk*
  │           │   ├── wardrobe*
  │           │   ├── ottoman*
  │           │   └── hifi_configuration*
  │           └── ensuite
  
  Legend:
  - area (primary room)
  - subarea* (contained space)
  - floor_id indicates physical level

# ══════════════════════════════════════════════════════════════════
# ACTIVITY TRACKING COVERAGE
# ══════════════════════════════════════════════════════════════════

activity_tracking_coverage:
  monitored_rooms: 8
  sensors_mapped:
    bedroom: "binary_sensor.bedroom_occupancy_beta"
    kitchen: "binary_sensor.kitchen_occupancy_beta"
    living_room: "binary_sensor.living_room_occupancy_beta"
    ensuite: "binary_sensor.ensuite_occupancy_beta"
    downstairs: "binary_sensor.hallway_downstairs_occupancy_beta"
    upstairs: "binary_sensor.hallway_upstairs_occupancy_beta"
    entrance: "binary_sensor.entrance_motion_beta"         # motion proxy
    desk: "binary_sensor.desk_occupancy_beta"
  
  not_tracked:
    - wardrobe: "No occupancy sensor (motion only)"
    - ottoman: "No occupancy sensor (vibration only)"
    - powder_room: "No occupancy sensor (vacuum only)"
    - laundry_room: "No occupancy sensor (vacuum only)"
    - hifi_configuration: "Virtual configuration area"

# ══════════════════════════════════════════════════════════════════
# NOTES
# ══════════════════════════════════════════════════════════════════

notes: |
  - Canonical room IDs are authoritative; sensor entity names may differ
  - All vacuum segment_id consolidated in node capabilities (single source of truth)
  - Spatial hierarchy enables motion/presence propagation inference
  - Floor IDs: 'downstairs' (ground), 'sanctum' (upstairs/private)
  - Activity tracking focuses on occupancy sensors (motion as fallback)
  - Subareas contribute to parent area occupancy via weighted aggregation