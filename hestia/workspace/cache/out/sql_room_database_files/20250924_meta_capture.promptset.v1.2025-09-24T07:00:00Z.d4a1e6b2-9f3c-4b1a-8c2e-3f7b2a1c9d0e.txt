promptset_id: "meta_capture.promptset.v1.2025-09-24T07:00:00Z.d4a1e6b2-9f3c-4b1a-8c2e-3f7b2a1c9d0e"
extracted_config:
  capture_time: "2025-09-24T07:00:00Z"
  host:
    name: ha (workspace /n/ha)
    user: evertappels
    uid: 503
  smb_share:
    server: 192.168.0.104
    share: HA_MIRROR
    url: "//babylonrobot@192.168.0.104/HA_MIRROR"
    account: babylonrobot
    protocol_hint: smb
  mount_commands:
    mount_tool: /sbin/mount_smbfs
    recommended_user_flags: ["-d 0777", "-f 0777"]
    recommended_daemon_flags: ["-d 0777", "-f 0777", "-N (use with keychain)"]
  components:
    user_helper:
      path: /Users/evertappels/Projects/HomeAssistant/ha_user_mount_helper.sh
      exists: true
      executable: true
      default_mount_point: /Users/evertappels/hass
      log_files:
        - ~/ha_mount_user.log
        - ~/ha_mount_user_stdout.log
        - ~/ha_mount_user_stderr.log
    user_launchagent:
      label: com.local.ha.mount
      plist: ~/Library/LaunchAgents/com.local.ha.mount.plist
      repo_symlink: /n/ha/hestia/core/system/symlinks/com.local.ha.mount.plist
      loaded: true
    system_daemon:
      label: com.local.ha.mount.real
      plist: /Library/LaunchDaemons/com.local.ha.mount.real.plist
      repo_symlink: /n/ha/hestia/core/system/symlinks/com.local.ha.mount.real.plist
      loaded: true
    system_helper:
      path: /usr/local/sbin/ha_mount_helper
      exists: unknown
    keychain:
      system_item:
        label: ha_nas_system
        keychain_path: /Library/Keychains/System.keychain
        exists: true
        server: 192.168.0.104
        account: babylonrobot
      login_item:
        server: 192.168.0.104
        account: babylonrobot
        exists: false
  repo:
    symlinks:
      - src: /n/ha/hestia/core/system/symlinks/com.local.ha.mount.plist
        target: ~/Library/LaunchAgents/com.local.ha.mount.plist
        exists: true
      - src: /n/ha/hestia/core/system/symlinks/com.local.ha.mount.real.plist
        target: /Library/LaunchDaemons/com.local.ha.mount.real.plist
        exists: true
      - src: /n/ha/hestia/core/system/symlinks/ha_user_mount_helper.sh
        target: /Users/evertappels/Projects/HomeAssistant/ha_user_mount_helper.sh
        exists: true
  nsmb_conf:
    path: /etc/nsmb.conf
    exists: false

transient_state:
  time_checked: "2025-09-24T07:00:00Z"
  mounts:
    - mount_point: /Users/evertappels/hass
      share: //babylonrobot@192.168.0.104/HA_MIRROR
      mounted_by: user (evertappels)
      owner_uid: 503
      owner_gid: 20
      mode: "0777"
      mounted: true
      writable_by_console_user: true
      last_verified: "2025-09-24T06:54:19Z"
    - mount_point: /private/var/ha_real
      share: //babylonrobot@192.168.0.104/HA_MIRROR
      mounted_by: system helper (com.local.ha.mount.real behavior logged)
      mounted: check_required
      last_logged_state: "already mounted" (found in /var/log/ha-mount.log)
  launchd:
    user_agent_loaded: true
    system_daemon_loaded: true
  logs_snapshot:
    system_log: /var/log/ha-mount.log (contains recent entries referencing TARGET_USER='evertappels' and "already mounted")
    user_logs: recent rotated and recreated; fresh files present
  keychain_state:
    system_item_present: true
    login_item_present: false

relationships:
  - subject: user_launchagent
    action: runs
    object: user_helper
  - subject: user_helper
    action: mounts
    object: /Users/evertappels/hass
  - subject: system_daemon
    action: runs
    object: system_helper
  - subject: system_helper
    action: intended_mount
    object: /private/var/ha_real
  - subject: system_keychain (ha_nas_system)
    action: provides_credentials_for
    object: system_helper / mount_smbfs (root)
  - subject: login_keychain (user internet-password)
    action: provides_credentials_for
    object: user_helper / mount_smbfs (user session) [optional, not present]

issues_detected:
  - id: dual_mechanism_loaded
    severity: medium
    description: Both user LaunchAgent and system LaunchDaemon are present and loaded. They target the same SMB share and may conflict if they attempt to mount the same mountpoint.
    evidence:
      - launchctl lists show both com.local.ha.mount and com.local.ha.mount.real loaded
      - /var/log/ha-mount.log contains "already mounted" messages originating from system helper
    suggested_action: disable one mechanism (prefer user LaunchAgent for console-user-owned mounts; prefer system daemon for pre-login system mounts). See actionable_next_steps.
  - id: system_helper_presence_unknown
    severity: low
    description: `/usr/local/sbin/ha_mount_helper` presence not verified; system daemon plist exists and is loaded but helper binary may be missing or different.
    suggested_action: verify helper binary exists and inspect its implementation or logs.

actionable_next_steps:
  - id: verify_system_helper
    steps:
      - "ls -l /usr/local/sbin/ha_mount_helper || true"
      - "sudo head -n 200 /usr/local/sbin/ha_mount_helper 2>/dev/null || sudo tail -n 200 /var/log/ha-mount.log"
  - id: pick_single_mount_mechanism
    recommendation: "If the share should be owned/writable by the console user, disable the system LaunchDaemon and keep the user LaunchAgent. If the share must be available before login (system-wide), disable the user LaunchAgent and use the system daemon with System keychain credentials."
    commands_disable_system:
      - "sudo launchctl unload -w /Library/LaunchDaemons/com.local.ha.mount.real.plist"
      - "sudo mv /Library/LaunchDaemons/com.local.ha.mount.real.plist /Library/LaunchDaemons/com.local.ha.mount.real.plist.disabled || true"
    commands_disable_user:
      - "launchctl unload -w ~/Library/LaunchAgents/com.local.ha.mount.plist"
      - "mv ~/Library/LaunchAgents/com.local.ha.mount.plist ~/Library/LaunchAgents/com.local.ha.mount.plist.disabled || true"
  - id: create_login_keychain_for_noninteractive_agent
    steps:
      - "security add-internet-password -s 192.168.0.104 -a babylonrobot -l 'ha_nas_user' -r 'smb ' -w '<PASSWORD>'"
      - "Ensure the login keychain is unlocked and test with: /sbin/mount_smbfs -N \"//babylonrobot@192.168.0.104/HA_MIRROR\" $HOME/hass"
    note: "Creating login-keychain entries should be done interactively by the user (do not store passwords in repo files)."
  - id: confirm_nsmb_conf_absence
    command: "ls -l /etc/nsmb.conf || true"
    note: "If present, remove plaintext credentials and prefer keychain entries."

verification_checks:
  - "launchctl list | grep com.local.ha.mount || true"
  - "sudo launchctl list | grep com.local.ha.mount.real || true"
  - "mount | grep HA_MIRROR -n"
  - "ls -ladn /Users/evertappels/hass /private/var/ha_real 2>/dev/null || true"
  - "sudo security find-internet-password -s 192.168.0.104 -a babylonrobot -r 'smb ' -g /Library/Keychains/System.keychain 2>/dev/null || true"
  - "smbutil statshares -m /Users/evertappels/hass"

notes:
  - "Timestamps are approximate and reflect the last observed activity in logs during this session."
  - "Use `-g` with `security` cautiously: it prints the password to stderr; prefer interactive checks in a secure terminal."
  - "The capture focuses on immediate reproducibility and operational safety (avoid storing secrets in repo)."
