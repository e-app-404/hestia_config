#!/usr/bin/env bash
set -euo pipefail
MP="/private/var/ha_real"
SRC="//babylonrobot@192.168.0.104/home"
LOG="/var/log/ha-mount.log"
exec >>"$LOG" 2>&1
printf '\n==== %s start ====' "$(date -Iseconds)"; echo

is_mounted(){ mount | grep -q " $MP "; }
prepare(){
  umount -f "$MP" 2>/dev/null || true
  mkdir -p "$MP"
}

attempt(){
  if is_mounted; then echo "already mounted"; return 0; fi
  /sbin/mount_smbfs -N "$SRC" "$MP"
}

prepare
if ! attempt; then
  echo "first attempt failed; cleaning and retrying"
  sleep 1
  umount -f "$MP" 2>/dev/null || true
  rmdir "$MP" 2>/dev/null || true
  mkdir -p "$MP"
  attempt
fi

is_mounted && echo "mounted OK at $MP" || { echo "failed"; exit 64; }
chown -R evertappels:staff "$MP" 2>/dev/null || true
