# File: /config/hestia/sensors/delta/hermes/presence/presence_confidence.yaml
# Description: Presence confidence score (Delta) — weighted fusion of GPS, sensors, and decayed presence
- sensor:
    - name: "Hermes Presence Confidence (Delta)"
      unique_id: hermes_presence_confidence_delta
      icon: mdi:account-check-outline
      unit_of_measurement: "%"
      state: >
        {% set threshold = states('input_number.presence_confidence_threshold') | float(50) %}
        {% set pal = state_attr('sensor.presence_abstraction_layer_delta', 'person_tracker') %}
        {% set dir = state_attr('sensor.presence_abstraction_layer_delta', 'direction_sensor') %}
        {% set dist = state_attr('sensor.presence_abstraction_layer_delta', 'gps_distance_sensor') %}
        {% set tracker = state_attr('sensor.presence_abstraction_layer_delta', 'device_tracker') %}
        {% set gps_present = pal is defined and is_state(pal, 'home') %}
        {% set direction_home = dir is defined and is_state(dir, 'arrived') %}
        {% set distance_close = dist is defined and (states(dist) | float(9999) < threshold) %}
        {% set wifi_connected = tracker is defined and is_state(tracker, 'home') %}
        {% set activity_detected = is_state('binary_sensor.floor_activity_detected_gamma', 'on') %}
        {% set desk_decay = states('sensor.desk_presence_decay_delta') | float(0) %}
        {% set bed_decay = states('sensor.bed_presence_decay_delta') | float(0) %}

        {% set components = [
          {'weight': 40, 'active': gps_present},
          {'weight': 10, 'active': direction_home},
          {'weight': 10, 'active': distance_close},
          {'weight': 10, 'active': wifi_connected},
          {'weight': 5,  'active': activity_detected},
          {'weight': 15, 'active': desk_decay > 4 },
          {'weight': 10, 'active': bed_decay > 4 }
        ] %}
        {{ components | selectattr('active') | map(attribute='weight') | sum }}
      attributes:
        tier: "δ"
        canonical_id: "presence_confidence_δ"
        subsystem: "hermes"
        module: "presence"
        type: "confidence_score"
        role: "weighted_fusion"
        decay_sources: "sensor.desk_presence_decay_delta, sensor.bed_presence_decay_delta"
        upstream_sources: >
          {{ [
            "input_number.presence_confidence_threshold",
            "binary_sensor.floor_activity_detected_gamma",
            "sensor.desk_presence_decay_delta",
            "sensor.bed_presence_decay_delta"
          ] | tojson }}

        derivation_method: "Weighted sum of spatial and behavioral indicators"
        validated_by: "iris"
        file: "/config/hestia/sensors/delta/hermes/presence/presence_confidence.yaml"
        changelog: >
          - 2025-05-09: Re-tiered to delta as presence confidence synthesizer

    - name: "Presence Abstraction Layer (Delta)"
      unique_id: "presence_abstraction_layer_delta"
      icon: mdi:account-eye
      state: "{{ now().isoformat() }}"
      attributes:
        description: "Aggregates GPS, direction, and device tracker into a unified presence abstraction sensor"
        person_tracker: >
          {% set people = expand('group.family') | selectattr('state', 'defined') | list %}
          {{ people[0].entity_id if people else 'person.evert' }}
        direction_sensor: sensor.home_nearest_direction_of_travel
        gps_distance_sensor: sensor.home_nearest_distance
        device_tracker: sensor.home_nearest_device
        tier: "δ"
        canonical_id: "presence_abstraction_δ"
        subsystem: "hermes"
        module: "presence"
        type: "aggregator"
        role: "abstraction"
        file: "/config/hestia/sensors/delta/hermes/presence/presence_confidence.yaml"
        validated: true
        derivation_method: >
          Aggregates real-time proximity direction, distance, and tracker identity from integration sensors
        upstream_sources: >
          {{ [
            "sensor.home_nearest_direction_of_travel",
            "sensor.home_nearest_distance",
            "sensor.home_nearest_device",
            "group.family"
          ] | tojson }}
        changelog: >
          - 2025-05-24: Finalized using Proximity sensors and group.family as defaults
