contract: Delta contract — β occupancy sensors (multi-room)
id: 20251021_occupancy_sensor_fix
planned_change: Expand β-layer occupancy signals (mirror α, add smoothing)
deliverable: 4 reliable β binary_sensors for Bedroom, Ensuite, Kitchen, Living Room
action_needed:
  - Remove/disable any prior trigger-based β entities for these rooms
  - Add the state-template definitions below (mirrors α + delay_off)
  - In Zigbee2MQTT, set model options consistently (see “Z2M calibration”)
  - Reload Template Entities (or restart HA)
rationale: Eliminate latched “Detected” states; standardize α→β pipeline
status: ready
path: /config/packages/occupancy_beta.yaml   # adjust if you use packages; otherwise in configuration.yaml
RACI_matrix:
  responsible: You
  accountable: Strategos
  consulted: HA logs, Zigbee2MQTT device pages
  informed: Automations depending on occupancy
acceptance_criteria:
  - Each β turns OFF within 30s (delay_off) after its α turns OFF
  - History graphs show correct Detected/Clear alternation for all four rooms
  - 3/3 passes of the verification checks per room (Clear → Detect → Clear)
risk_assessment:
  - low: config-only; rollback is file revert + reload

template_entities:
  - note: If your α entity IDs differ, swap the binary_sensor.<room>_occupancy_alpha_occupancy names accordingly.
template:
  - binary_sensor:
      # BEDROOM
      - name: "Bedroom Occupancy (Beta)"
        unique_id: bedroom_occupancy_beta
        device_class: occupancy
        state: "{{ is_state('binary_sensor.bedroom_occupancy_alpha_occupancy', 'on') }}"
        delay_off:
          seconds: 30
        availability: >
          {{ states('binary_sensor.bedroom_occupancy_alpha_occupancy') in ['on','off'] }}

      # ENSUITE
      - name: "Ensuite Occupancy (Beta)"
        unique_id: ensuite_occupancy_beta
        device_class: occupancy
        state: "{{ is_state('binary_sensor.ensuite_occupancy_alpha_occupancy', 'on') }}"
        delay_off:
          seconds: 30
        availability: >
          {{ states('binary_sensor.ensuite_occupancy_alpha_occupancy') in ['on','off'] }}

      # KITCHEN
      - name: "Kitchen Occupancy (Beta)"
        unique_id: kitchen_occupancy_beta
        device_class: occupancy
        state: "{{ is_state('binary_sensor.kitchen_occupancy_alpha_occupancy', 'on') }}"
        delay_off:
          seconds: 30
        availability: >
          {{ states('binary_sensor.kitchen_occupancy_alpha_occupancy') in ['on','off'] }}

      # LIVING ROOM
      - name: "Living Room Occupancy (Beta)"
        unique_id: living_room_occupancy_beta
        device_class: occupancy
        state: "{{ is_state('binary_sensor.living_room_occupancy_alpha_occupancy', 'on') }}"
        delay_off:
          seconds: 30
        availability: >
          {{ states('binary_sensor.living_room_occupancy_alpha_occupancy') in ['on','off'] }}

Zigbee2MQTT calibration (SNZB-06P model):
  - bedroom_occupancy_alpha_occupancy
  - ensuite_occupancy_alpha_occupancy
  - kitchen_occupancy_alpha_occupancy
  - living_room_occupancy_alpha_occupancy

adjustments:
  - Occupancy sensitivity: medium (bump to high only if misses occur).
  - Occupancy timeout: 60 seconds (tune later as you like).
  - Settings (specific) → No occupancy since: [10, 60, 300] (optional but recommended for diagnostics/advanced rules).
