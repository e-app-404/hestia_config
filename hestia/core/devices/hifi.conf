# file: hifi.conf
# -----------------------------------------------------------------------------
# Bedroom A/V topology & declarative source map for a Universal media_player.
# This file is consumed by the universal config (see hifi.config.yaml / packages).
#
# Changelog (2025‑09‑05):
# - Standardized canonical source labels + aliases (Playstation 4 vs Playstation 4, PS4)
# - Declared single source‑of‑truth HDMI matrix input map (1=Apple TV, 2=Switch, 3=PS4, 4=Wii)
# - Reordered priority to match current Universal active_child precedence (TV > Apple TV > PS4 > Sonos)
# - Added TV hub switching hint (HDMI vs TV tuner) used by scripts/automations
# - Tightened comments; aligned with Broadlink commands & current package scripts
#
# References:
# - Universal integration: https://www.home-assistant.io/integrations/universal/
# - 2024.8 release (service calls are now actions): https://www.home-assistant.io/blog/2024/08/07/release-20248/
# - Universal component source (behavior & keys): https://github.com/home-assistant/core/tree/dev/homeassistant/components/universal
# -----------------------------------------------------------------------------

# ─────────────────────────────────────────────────────────────────────────────
# CANONICAL LABELS + ALIASES (avoid string drift across packages/scripts)
# ─────────────────────────────────────────────────────────────────────────────
labels:
  canonical:
    - "Samsung TV"
    - "DLNA (TV)"
    - "Plex (Samsung TV app)"
    - "Chromecast (TV)"
    - "Apple TV (Home screen)"
    - "Apple TV – Plex"
    - "AirPlay (via Apple TV)"
    - "Playstation 4"
    - "Nintendo Switch"
    - "Nintendo Wii"
  aliases:
    "Playstation 4": ["Playstation 4", "PS4", "Sony Playstation 4"]
    "Apple TV – Plex": ["Plex (Apple TV)"]
    "Chromecast (TV)": ["Cast", "Smart View"]
    "Samsung TV": ["TV", "TV/ANT", "TV Plus"]

# ─────────────────────────────────────────────────────────────────────────────
# SINGLE SOURCE‑OF‑TRUTH: HDMI MATRIX INPUT MAP (align A & B routing)
# Keep this in sync with Broadlink IR commands a_*/b_* and scripts.matrix_control
# ─────────────────────────────────────────────────────────────────────────────
matrix_inputs:
  "1": "Apple TV"
  "2": "Nintendo Switch"
  "3": "Playstation 4"
  "4": "Nintendo Wii"

# ─────────────────────────────────────────────────────────────────────────────
# SOURCES (canonical → route + control hints)
# ─────────────────────────────────────────────────────────────────────────────
sources:
  # --- TV-native paths (no HDMI matrix video source) ---
  "Samsung TV":
    route:
      kind: internal_tv
      hub_switch: "TV"   # scripts will switch media_player.bedroom_tv_alpha_hub to TV when selected
    device: media_player.bedroom_tv_alpha
    app: "TV"            # tuner label varies by model; see aliases above
    audio_sink: media_player.bedroom_sonos_ray
    rationale: "Use TV’s own tuner; matrix not used. Audio via ARC → Sonos Ray volume exposed via Universal."

  "DLNA (TV)":
    route: { kind: internal_tv, hub_switch: "HDMI" }
    device: media_player.bedroom_tv_alpha_dlna
    app: "DLNA"
    audio_sink: media_player.bedroom_sonos_ray
    rationale: "Samsung DLNA app; entity may be unavailable. Ensure TV is on and app is foregrounded if possible."

  "Plex (Samsung TV app)":
    route: { kind: internal_tv, hub_switch: "HDMI" }
    device: media_player.bedroom_tv_alpha_plex
    app: "Plex"
    audio_sink: media_player.bedroom_sonos_ray
    rationale: "Native Plex on TV; audio remains ARC → Sonos Ray."

  "Chromecast (TV)":
    route: { kind: internal_tv, hub_switch: "HDMI" }
    device: media_player.bedroom_tv_alpha
    app: "Chromecast"
    audio_sink: media_player.bedroom_sonos_ray
    rationale: "Cast receiver built into the TV."

  # --- HDMI matrix paths (A → TV video, B → SONOS Ray audio) ---
  "AirPlay (via Apple TV)":
    route: { kind: matrix, a: 1, b: 1 }
    device: media_player.bedroom_apple_tv_alpha
    app: null
    audio_sink: media_player.bedroom_sonos_ray
    rationale: "Route Apple TV for AirPlay; no explicit app selection."

  "Apple TV (Home screen)":
    route: { kind: matrix, a: 1, b: 1 }
    device: media_player.bedroom_apple_tv_alpha
    app: null   # home via remote command
    audio_sink: media_player.bedroom_sonos_ray
    rationale: "General Apple TV use; remote command can foreground Home."

  "Apple TV – Plex":
    route: { kind: matrix, a: 1, b: 1 }
    device: media_player.bedroom_apple_tv_alpha
    app: "Plex" # media_player.select_source → "Plex"
    audio_sink: media_player.bedroom_sonos_ray
    rationale: "Launch Plex on Apple TV and route A/B to Apple TV."

  "Playstation 4":
    route: { kind: matrix, a: 3, b: 3 }
    device: media_player.playstation_4
    app: null
    audio_sink: media_player.bedroom_sonos_ray
    rationale: "Route only; optional separate package can wake PS4 / show recents."

  "Nintendo Switch":
    route: { kind: matrix, a: 2, b: 2 }
    device: null
    app: null
    audio_sink: media_player.bedroom_sonos_ray
    rationale: "Route only; no HA control entity."

  "Nintendo Wii":
    route: { kind: matrix, a: 4, b: 4 }
    device: null
    app: null
    audio_sink: media_player.bedroom_sonos_ray
    rationale: "Route only; no HA control entity."

# ─────────────────────────────────────────────────────────────────────────────
# PRIORITY ORDER (first non‑idle child wins) — keep in sync with Universal
# ─────────────────────────────────────────────────────────────────────────────
priority:
  - media_player.bedroom_tv_alpha           # on → master
  - media_player.bedroom_apple_tv_alpha     # playing → next
  - media_player.playstation_4              # on → next
  - media_player.bedroom_sonos_ray          # playing → fallback

# ─────────────────────────────────────────────────────────────────────────────
# ENTITIES (groupings used by templates/automations)
# ─────────────────────────────────────────────────────────────────────────────
entities:
  tv:
    - media_player.bedroom_tv_alpha
    - media_player.bedroom_tv_alpha_hub      # used to switch HDMI↔TV
    - media_player.bedroom_apple_tv_alpha
    - media_player.bedroom_apple_tv_alpha_plex  # may be restored/unavailable; not used directly
  consoles:
    - media_player.playstation_4
  audio:
    - media_player.bedroom_sonos_ray
    - media_player.bedroom_sonos_surround
    # - media_player.ensuite_sonos_roam     # optional alerts-only child

# ─────────────────────────────────────────────────────────────────────────────
# SAFETY / TIMING HINTS (used by scripts)
# ─────────────────────────────────────────────────────────────────────────────
safety:
  power_on_wait: "3s"        # give TV time to accept HDMI routing after power
  matrix_switch_wait: "300ms" # IR/relay debounce between A/B commands
  app_launch_wait: "2.5s"     # time for Apple TV to foreground an app
  retries:
    matrix_command: 1

# ─────────────────────────────────────────────────────────────────────────────
# VALIDATION NOTES
# - Keep matrix_inputs authoritative; update packages/scripts to reference it.
# - Universal 'attributes' are static mappings (no Jinja); dynamic titles require a separate template sensor.
# - Universal command 'select_source' should call a script that understands these labels.
#   Current packages use script.bedroom_matrix_select_source / script.matrix_control.
#   If media_player.universal.select_source points to script.bedroom_universal_route_for_source,
#   ensure that script exists or repoint to bedroom_matrix_select_source.
# -----------------------------------------------------------------------------
