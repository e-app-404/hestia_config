# cloudflare.config.yaml
_meta:
  project: HADES_NIE
  domain: network/cloudflare
  version: 1.0
  generated_utc: "2025-08-19T00:00:00Z"
  source_files:
    - "cloudflared.html"
    - "dns.topology.json"
    - "network.configuration.yaml"
    - "network.topology.json"
  coverage:
    dns: true
    tunnel: true
    rules: true
    zero_trust: false
    deployment: true
  provenance_notes: |
    - Hostname→service mappings and 404 fallback observed in cloudflared logs.
    - DNS hostnames (nas.xplab.io, plex.xplab.io) evidenced by successful curl tests.
    - Redirect/Page Rule configuration derived from session steps and confirmations.
    - DSM host/IP and port (192.168.0.104:5001) from session context and tests.

account:
  zone: "xplab.io"
  registrar: "Ionos"
  nameservers: null

dns:
  apex:
    A: null
    AAAA: null
  records:
    - name: "nas.xplab.io"
      type: "CNAME"
      proxied: true
      target: null
      ttl: null
    - name: "plex.xplab.io"
      type: "CNAME"
      proxied: true
      target: null
      ttl: null

tunnels:
  - name: "synology-dsm"
    id: null
    mode: "token-managed"
    fallback: "http_status:404"
    hostnames:
      - hostname: "nas.xplab.io"
        service: "https://192.168.0.104:5001"
        origin:
          tls: true
          no_tls_verify: true
      - hostname: "plex.xplab.io"
        service: "http://192.168.0.104:32400"
        origin:
          tls: false
          no_tls_verify: false
    notes: |
      - Cloudflared logs showed DSM mapping on 5001 with noTLSVerify and a catch-all 404.
      - plex.xplab.io added under same tunnel; origin scheme currently HTTP to 32400 per session steps.

rules:
  page_rules:
    - pattern: "plex.xplab.io/*"
      settings:
        cache_level: "bypass"
        rocket_loader: "off"
        email_obfuscation: "off"
        browser_integrity_check: "off"
        automatic_https_rewrites: "off"
        zaraz: "disabled"
  redirect_rules:
    - pattern: "http://plex.xplab.io/*"
      destination: "https://plex.xplab.io/$1"
      status: 301
      preserve_query: true
  configuration_rules: []
  cache_rules: []

zero_trust:
  access_apps: []
  policies: []

cloudflared_deployment:
  platform: "Synology DSM (Container Manager)"
  image: null
  run_mode: "tunnel run --token"
  network_mode: "bridge"
  restart_policy: "no"
  volumes: []
  env:
    SSL_CERT_FILE: "/etc/ssl/certs/ca-certificates.crt"
  health:
    last_log_sample: null
    signals: []
    errors_recent:
      - "Unable to reach origin service (use of closed network connection)"
      - "TLS handshake timeout"

dependencies:
  tailscale:
    magicdns: null
    search_domain: null
    dns: null
  services:
    dsm_ui:
      url: "https://nas.xplab.io"
      origin: "https://192.168.0.104:5001"
    plex_web:
      url: "https://plex.xplab.io/web"
      origin: "http://192.168.0.104:32400"

issues_log:
  - id: "plex-login-handoff"
    observed: "Login loop from accounts.plex.tv when proxied; later 502 after HTTPS redirect."
    suspected_causes:
      - "Cloudflare optimizations interfering with auth callback"
      - "Third-party cookie restrictions"
      - "HTTP/HTTPS origin mismatch between tunnel and Plex 'Secure connections'"
    remediation:
      - "Bypass cache & optimizations for plex.xplab.io"
      - "Add HTTP→HTTPS redirect rule"
      - "Align origin scheme (Preferred HTTP or Required with HTTPS+noTLSVerify)"
    status: "open"
  - id: "unknown-fields-redaction"
    observed: "Certain DNS targets, nameservers, tunnel ID, and image tag not evidenced in-session."
    suspected_causes:
      - "Values not shared in artifacts"
    remediation:
      - "Populate from Cloudflare DNS and Tunnel dashboards when available"
    status: "open"

verification:
  commands:
    - name: "plex root response"
      cmd: "curl -sI https://plex.xplab.io | head -n1"
      expect: "HTTP/2 200|401"
    - name: "plex web app"
      cmd: "curl -sL -o /dev/null -w '%{http_code} %{url_effective}\\n' https://plex.xplab.io/web"
      expect: "200 .../web/index.html"
    - name: "nas ui"
      cmd: "curl -sI https://nas.xplab.io | head -n1"
      expect: "HTTP/2 200"
  status: "fail"
  last_checked_utc: "2025-08-19T00:00:00Z"

governance_confidence:
  structural: 0.82
  operational: 0.72
  semantic: 0.68
# (END OF FILE)
