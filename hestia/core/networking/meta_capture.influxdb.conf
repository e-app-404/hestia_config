# meta_capture.output.v1 — derived from meta_capture.promptset.v1
# Source window: this conversation up to 2025-09-18
# session_id: 68c7e0e3-9a94-832c-8aec-6f8882f825da

extracted_config:
  devices:
    homeassistant_core:
      role: "Home Assistant (Supervised, HA OS)"
      os: "Home Assistant OS 16.2"
      arch: "aarch64 / raspberrypi5-64"
      core_version: "2025.9.3"
      supervisor_version: "2025.09.0"
      hostname: "homeassistant.local"
      services:
        - name: "Home Assistant UI"
          port: 8123/tcp
      config:
        http:
          use_x_forwarded_for: true
          trusted_proxies: ["127.0.0.1"]
        auth_providers:
          - type: homeassistant
          - type: trusted_networks
            trusted_networks:
              - 192.168.0.0/24
              - 100.92.58.104/24
        recorder:
          db_url: "mysql://babylon-mariadb:********@core-mariadb/homeassistant?charset=utf8mb4"
          auto_purge: true
          purge_keep_days: 7
          commit_interval: 30
        integrations:
          influxdb_v2:
            api_version: 2
            url: "http://192.168.0.104:8086"
            organization: "Hestia"
            bucket: "homeassistant"
            token: "!secret influxdb_token"
            ssl: false
            verify_ssl: false
            include:
              domains: [sensor, binary_sensor, climate, switch]
              entity_globs:
                - sensor.temperature_*
                - sensor.humidity_*
                - sensor.*_energy
                - sensor.*_power
                - binary_sensor.motion_*
                - binary_sensor.occupancy_*
                - sensor.evert_health_biometrics_*
                - binary_sensor.evert_health_biometrics_*
                - sensor.evert_sleep_*
                - sensor.ds220plus_library_*
            exclude:
              domains: [media_player, zone, updater, group]
              entity_globs:
                - sensor.sun*
                - sensor.date*
                - sensor.time*
                - sensor.*_entity_list
                - sensor.*failover_summary
                - sensor.*_minutes_since_*
            ignore_attributes:
              - entities
              - upstream_sources
              - description
              - friendly_name
              - icon
              - subsystem
              - module
              - canonical_id
              - canonical_tier
            tags_attributes: [unit_of_measurement, device_class, friendly_name]
    core_mariadb_addon:
      role: "HA add-on (MariaDB)"
      slug: "core_mariadb"
      version: "2.7.2"
      state: "started"
      db:
        name: "homeassistant"
        user: "babylon-mariadb"
        grants: "ALL PRIVILEGES ON homeassistant.* TO 'babylon-mariadb'@'%'"
      notes:
        - "Supervisor logs show: Unknown option 'host' and 'grant' in add-on options — remove unsupported keys from add-on config."
    a0d7b954_influxdb_addon:
      role: "HA add-on (InfluxDB 1.x)"
      slug: "a0d7b954_influxdb"
      version: "5.0.2"
      state: "stopped/retired"  # should remain disabled; HA uses NAS InfluxDB v2
    ds220plus:
      role: "Synology NAS (Docker host)"
      ip: "192.168.0.104"
      docker:
        server_version: "24.0.2"
        storage_driver: "btrfs"
      containers:
        - name: "influxdb2"
          image: "influxdb:2.7"
          state: "running"
          ports:
            - "8086:8086/tcp"
          mounts:
            - "/volume1/docker/influxdb2 -> /var/lib/influxdb2"
            - "/volume1/@docker/volumes/<anon>/_data -> /etc/influxdb2"
          healthcheck: "none (consider adding)"
          init_setup:
            org: "Hestia"            # ID dbe505ac34560afd
            bucket: "homeassistant"  # ID baa7a66ff602926f, retention 30d
            admin_token: "redacted"
            ha_rw_token_description: "Home Assistant RW token"
            ha_rw_token: "redacted"
      backups:
        influxdb2:
          path: "/volume1/backups/influxdb2"
          last_backup_dir: "/volume1/backups/influxdb2/online-2025-09-18_154059"
          artifacts:
            - "20250918T154103Z.manifest"
            - "20250918T154103Z.bolt.gz"
            - "20250918T154103Z.sqlite.gz"
            - "20250918T154103Z.1.tar.gz"
          size_estimate: "≈20K (initial/small dataset)"

transient_state:
  ha_core:
    status: "RUNNING"
    recent_warnings:
      - ts: "2025-09-17 ~"
        component: "template"
        msg: "Template variable warning: No first item, sequence was empty."
        source: "get_active_source() macro from template.library.jinja"
      - ts: "2025-09-17 06:41:54+"
        component: "sensor.rest"
        entities: ["sensor.macbook_disk_used","sensor.macbook_swap_percent"]
        msg: "Non-numeric value while device/unit suggest numeric ('0 # PATCH: Already error tolerant')"
      - ts: "2025-09-17"
        component: "command_line"
        msg: "Timeouts querying http://100.93.61.53:32400/identity"
      - ts: "2025-09-17"
        component: "webhook"
        msg: "GET sent to POST-only webhook; one mobile_app webhook KeyError"
  ha_supervisor:
    recent_info:
      - "Multiple add-ons in error/unknown state (Glances, Tailscale, Zigbee2MQTT, Whisper, Piper, etc.)"
      - "Add-on store updates succeeded."
      - "Unknown options in MariaDB add-on ('host', 'grant')."
  influxdb2_nas:
    status: "running"
    logs_summary:
      - "HTTP listener active on :8086"
      - "Retention checks running every 30m"
    health: "n/a (no container HEALTHCHECK configured)"
  mariadb_addon:
    status: "started"
    note: "Recorder connected; previous 'Ended unfinished session' noted once at 2025-09-17 07:36:41"

relationships:
  - from: "homeassistant_core:integration:influxdb_v2"
    to: "ds220plus:container:influxdb2"
    via: "http://192.168.0.104:8086 (TCP 8086)"
    auth: "HA RW token (redacted)"
    bucket: "homeassistant"
    org: "Hestia"
  - from: "homeassistant_core:recorder"
    to: "core_mariadb_addon"
    via: "mysql://...@core-mariadb/homeassistant?charset=utf8mb4"
  - from: "ds220plus:container:influxdb2"
    to: "backups"
    via: "/volume1/backups/influxdb2 (online backups created with influx backup)"
  - from: "homeassistant_core:templates"
    to: "template.library.jinja"
    via: "macros get_active_source(), preference_select() used by occupancy/motion templates"

suggested_commands:
  # --- NAS: add container healthcheck (recreate with HC) ---
  - label: "Recreate influxdb2 with HEALTHCHECK (optional improvement)"
    cmd: |
      docker rm -f influxdb2 && \
      docker run -d --name influxdb2 \
        -p 8086:8086 \
        -v /volume1/docker/influxdb2:/var/lib/influxdb2 \
        --health-cmd='wget --spider -q http://127.0.0.1:8086/health || exit 1' \
        --health-interval=30s --health-timeout=3s --health-retries=3 \
        --restart unless-stopped influxdb:2.7
  # --- NAS: firewall restrict 8086 to HA host only ---
  - label: "Synology firewall — allow 8086 from HA only, then drop"
    steps:
      - "Control Panel → Security → Firewall → Edit Rules"
      - "Create rule: Allow | From: <HA host IP/CIDR> | Ports: 8086 TCP | Interface: LAN"
      - "Create rule: Deny | From: all | Ports: 8086 TCP"
      - "Move Allow rule above Deny; Apply."
  # --- HA: ensure only NAS InfluxDB is configured ---
  - label: "Disable old InfluxDB add-on target in HA"
    cmd: |
      # In HA UI: stop & disable 'InfluxDB' add-on (a0d7b954_influxdb)
      # Confirm HA configuration points only to url: http://192.168.0.104:8086
      ha core check && ha core restart
  # --- HA: test write path end-to-end with HA token (from secrets) ---
  - label: "Smoketest write from HA host (replace TOKEN from !secret)"
    cmd: |
      TOKEN="$(grep ^influxdb_token: /config/secrets.yaml | awk '{print $2}')" && \
      curl -sS -XPOST "http://192.168.0.104:8086/api/v2/write?org=Hestia&bucket=homeassistant&precision=s" \
        -H "Authorization: Token ${TOKEN}" \
        --data-raw "ha_smoketest,host=ha value=1 $(date +%s)"
  # --- NAS: verify datapoint landed ---
  - label: "Query smoketest datapoint on NAS"
    cmd: |
      docker exec -it influxdb2 influx query \
        'from(bucket:"homeassistant") |> range(start:-10m) |> filter(fn: (r) => r._measurement == "ha_smoketest")'
  # --- NAS: backup (working form with ADMIN token) ---
  - label: "On-demand InfluxDB online backup"
    cmd: |
      BACKUP_DIR=/volume1/backups/influxdb2
      mkdir -p "$BACKUP_DIR"
      docker run --rm --network container:influxdb2 \
        -v "$BACKUP_DIR":/backups influxdb:2.7 influx backup \
        --host http://127.0.0.1:8086 \
        --token "<ADMIN_TOKEN>" \
        /backups/online-$(date +%F_%H%M%S)
  # --- HA: fix MariaDB add-on options schema warnings ---
  - label: "Clean unsupported MariaDB add-on options"
    notes: "Remove 'host' and 'grant' keys if present under add-on options. The add-on grants come from its internal schema; your SQL GRANTs are already correct."
  # --- HA: template hardening to reduce 'No first item' spam ---
  - label: "Guard macros for empty sources"
    snippet: |
      {% from 'custom_templates/template.library.jinja' import get_active_source %}
      {% set sources = [...] %}
      {% set src = get_active_source(sources) %}
      {{ src if src is string and src|length > 0 else 'unknown' }}

notes:
  - Security: Store all tokens in HA `secrets.yaml` and not in repo; rotate admin token after creating scoped HA RW token.
  - InfluxDB v2 retention is per-bucket; you already have 30d — confirm with: `docker exec influxdb2 influx bucket list --org Hestia`.
  - Keep the HA InfluxDB add-on **disabled**; it previously caused name-resolution errors (`a0d7b954-influxdb`) and is no longer needed.
  - Consider adding a nightly backup cron on the NAS (Hyper Backup or root cron) for `/volume1/docker/influxdb2` and `/volume1/backups/influxdb2`.
  - Several HA add-ons show `error/unknown` state; audit and remove unused ones to reduce log noise and risk.
  - REST sensors returning `'0 # PATCH: Already error tolerant'` should emit pure numeric strings if they advertise `%` — fix templates/REST parsing or remove device_class/unit if value is non-numeric.
