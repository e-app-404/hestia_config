# AREA HIERARCHY & SPATIAL RELATIONSHIP CONTRACT
# Canonical definition of area → room → floor containment and propagation rules
# Status: DRAFT v1
# Last Updated: 2025-07-22
# PATCH-JOIN-CONTRACT-ROOM-MAPPING-V1

contract:
  id: area_relationships_contract
  version: 1.1
  author: Evert
  status: canonical_draft
  file_path: canonical/support/contracts/area_hierarchy.yaml

contract_metadata:
  last_validated: "2025-10-04"
  live_registry_consistency: improved
  coverage_percent: 100.0
  notes: |
    This contract is programmatically validated against live Home Assistant registry data. Coverage and consistency are updated on each validation run.
    Major patch 2025-10-04: Fixed duplicate downstairs entries, added missing nodes (sanctum, clapham, warnings), corrected canonical names to match registry exactly, fixed data type inconsistencies, and completed incomplete node definitions.

containment_graph:
  home:
    children: [evert, home, hestia, hallway] # Note: difference floor_id: home vs area_id: home
  hestia:
    children: [tailscale_vpn, config, diag, configuration_toggles, ha_addons, ha_system, system_admin, virtual, device_status, glances]
    note: |
      Hestia is only available as a container for system organization, not a physical location. There is no area_id: hestia created in the registry until 
      such time this is considered necessary.
  hallway:
      children: [downstairs, upstairs, hallway]  # Shared areas connecting both floors
  downstairs: # floor id downstairs, meaning ground floor
    children: [kitchen, laundry_room, living_room, powder_room, entrance]
  sanctum:
      children: [bedroom, ensuite]
  bedroom:
    children: [desk, hifi_configuration, wardrobe, ottoman]
  
  # Hestia children areas for system organization
  diag:
    children: [folder_watcher, backups, host_system]
  services:
    children: [alarm, calendar, notifications, cleaning, warnings]
  network:
    children: [home_assistant, media_server, nas, network_connectivity, network_health, tailscale_vpn, glances] # network_connectivity maps to name: Hubs & Routers
  outside:
    children: [london, clapham]
  config:
    children: [config, configuration_toggles, ha_addons, ha_system, system_admin, virtual, device_status]
  
  ensuite: null
  kitchen: null
  laundry_room: null
  living_room: null
  entrance: null
  upstairs: null
  glances: null
  clapham: null
  ottoman: null
  tailscale_vpn: null
  note: |
    Core.*_registry files may compress multiple nested areas into a simple area_id mapping for simplicity, and to reduce the need for duplicate
    floor_id vs area_id definitions.

nodes:
  - id: hallway
    type: area
    canonical_name: Hallway
    parents: [home]
    container: ["area", "hallway", "Hallway"]
    devices: 6
    entities: 0
    services: 0
    tags: [transit, structural_connector]
  - id: kitchen
    type: area
    canonical_name: Kitchen
    parents: [downstairs]
    container: ["area", "kitchen", "Kitchen"]
    devices: 18
    entities: 4
    services: 0
  - id: laundry_room
    type: area
    canonical_name: Laundry room
    parents: [downstairs]
    container: ["area", "laundry_room", "Laundry room"]
    devices: 2
    entities: 0
    services: 0
  - id: living_room
    type: area
    canonical_name: Living Room
    parents: [downstairs]
    container: ["area", "living_room", "Living Room"]
    devices: 25
    entities: 5
    services: 0
  - id: entrance
    type: subarea
    canonical_name: Entrance
    parents: [downstairs]
    container: ["area", "entrance", "Entrance"]
    devices: 5
    entities: 3
    services: 0
  - id: downstairs
    type: area
    canonical_name: Downstairs
    parents: [hallway]
    container: ["area", "downstairs", "Downstairs"]
    devices: 5
    entities: 4
    services: 0
  - id: upstairs
    type: area
    canonical_name: upstairs
    parents: [hallway]
    container: ["area", "upstairs", "upstairs"]
    devices: 5
    entities: 5
    services: 0
  - id: bedroom
    type: area
    canonical_name: Bedroom
    parents: [sanctum]
    container: ["area", "bedroom", "Bedroom"]
    devices: 66
    entities: 7
    services: 0
  - id: desk
    type: subarea
    canonical_name: desk
    parents: [bedroom]
    container: ["area", "desk", "Desk"]
    devices: 20
    entities: 0
    services: 0
  - id: wardrobe
    type: subarea
    canonical_name: Wardrobe
    parents: [bedroom]
    container: ["area", "wardrobe", "Wardrobe"]
    devices: 4
    entities: 2
    services: 0
  - id: hifi_configuration
    type: subarea
    canonical_name: hifi configuration
    parents: [bedroom]
    container: ["area", "hifi_configuration", "hifi configuration"]
    devices: 0
    entities: 0
    services: 0
  - id: ensuite
    type: area
    canonical_name: Ensuite
    parents: [sanctum]
    container: ["area", "ensuite", "Ensuite"]
    devices: 16
    entities: 4
    services: 0
  - id: evert
    type: person
    canonical_name: Evert
    parents: [home]
    container: ["area", "evert", "Evert"]
    devices: 9
    entities: 3
    services: 1
  - id: calendar
    type: service
    canonical_name: Calendar
    parents: [services]
    container: ["area", "calendar", "Calendar"]
    devices: 0
    entities: 11
    services: 1
  - id: alarm
    type: service
    canonical_name: Alarm
    parents: [services]
    container: ["area", "alarm", "Alarm"]
    devices: 0
    entities: 7
    services: 1
  - id: notifications
    type: service
    canonical_name: Notifications
    parents: [services]
    container: ["area", "notifications", "Notifications"]
    devices: 0
    entities: 0
    services: 1
  - id: cleaning
    type: service
    canonical_name: Cleaning
    parents: [services]
    container: ["area", "cleaning", "Cleaning"]
    devices: 1
    entities: 0
    services: 0
    tags: ["valetudo", "robot_vacuum"]
  - id: network_connectivity
    type: area
    canonical_name: Hubs & Routers
    parents: [home]
    container: ["area", "network_connectivity", "Hubs & Routers"]
    devices: 0
    entities: 0
    services: 0
    tags: [network, infrastructure]
  - id: media_server
    type: area
    canonical_name: Media Server
    parents: [network]
    container: ["area", "media_server", "Media Server"]
    devices: 0
    entities: 0
    services: 0
    tags: [media, network]
  - id: home_assistant
    type: area
    canonical_name: Home Assistant
    parents: [network]
    container: ["area", "home_assistant", "Home Assistant"]
    devices: 0
    entities: 0
    services: 0
    tags: [system, network]
  - id: powder_room
    type: area
    canonical_name: powder room
    parents: [downstairs]
    container: ["area", "powder_room", "powder room"]
    devices: 0
    entities: 0
    services: 0
    tags: ["bathroom", "toilet"]
  - id: config
    type: system
    canonical_name: Config
    parents: [hestia]
    container: ["area", "config", "Configuration"]
    devices: 0
    entities: 0
    services: 0
    tags: [configuration]
  - id: diag
    type: system
    canonical_name: Diagnostics
    parents: [hestia]
    container: ["area", "diag", "Diagnostics"]
    devices: 0
    entities: 0
    services: 0
    tags: [diagnostics, monitoring]
  - id: ottoman
    type: subarea
    canonical_name: Ottoman
    parents: [bedroom]
    container: ["area", "ottoman", "Ottoman"]
    devices: 1
    entities: 0
    services: 0
  - id: tailscale_vpn
    type: area
    canonical_name: Tailscale VPN
    parents: [network, hestia]
    container: ["area", "tailscale_vpn", "Tailscale VPN"]
    devices: 0
    entities: 0
    services: 0
    tags: [network, security]
  - id: sanctum
    type: area
    canonical_name: sanctum
    parents: [upstairs]
    container: ["area", "sanctum", "sanctum"]
    devices: 0
    entities: 0
    services: 0
    tags: [private, upstairs]
  - id: clapham
    type: area
    canonical_name: clapham
    parents: [outside]
    container: ["area", "clapham", "clapham"]
    devices: 0
    entities: 0
    services: 0
    tags: [location, outside]
  - id: warnings
    type: service
    canonical_name: Warnings
    parents: [services]
    container: ["area", "warnings", "Warnings"]
    devices: 0
    entities: 0
    services: 0
    tags: [alerts, monitoring]
  - id: host_system
    type: system
    canonical_name: Host System
    parents: [diag]
    container: ["area", "host_system", "Host System"]
    devices: 0
    entities: 0
    services: 0
    tags: [system, host]
  - id: folder_watcher
    type: system
    canonical_name: Folder Watcher
    parents: [diag]
    container: ["area", "folder_watcher", "Folder Watcher"]
    devices: 0
    entities: 0
    services: 0
    tags: [monitoring, filesystem]
  - id: backups
    type: system
    canonical_name: Backups
    parents: [diag]
    container: ["area", "backups", "Backups"]
    devices: 0
    entities: 0
    services: 0
    tags: [backup, recovery]
  - id: system_admin
    type: system
    canonical_name: System Admin
    parents: [config]
    container: ["area", "system_admin", "System Admin"]
    devices: 0     
    entities: 0
    services: 0
    tags: [administration, management]

propagation_rules:
  motion:
    from_subarea_to_area: probable # e.g., desk → bedroom
    from_area_to_subarea: improbable # e.g., bedroom → desk
    from_area_to_container: probable # e.g., bedroom → sanctum
    from_container_to_area: undefined
    transient_decay: true # motion loses confidence across boundaries
    decay_rate: 0.7 # relative confidence reduction per level
    tags: [decay, boundary, propagation]
  presence:
    from_subarea_to_area: possible
    from_area_to_subarea: rare
    from_area_to_container: possible
    from_container_to_area: unlikely
    memory: sticky # presence has higher retention than motion
    tags: [retention, propagation]
  occupancy:
    aggregate_method: weighted_sum
    weights:
      subarea: 0.6
      area: 1.0
      container: 0.4
    decay_profile:
      subarea_timeout: 2m
      area_timeout: 5m
      container_timeout: 10m
    tags: [aggregation, decay]
  graph:
    allow_cycles: false
    max_depth: 5
    transitive_inference: true
    tags: [graph, traversal]

output_contract:
  emit_to: canonical/joins/area_room_floor_hierarchy.json
  schema:
    - area_id: string
    - parent_room: string | null
    - floor_id: string
    - type: enum(area, subarea, floor, service)
    - inference_weight: float
    - contributes_to: list[string]
    - inferred_by: string | null

notes: |
  The purpose of this contract is to standardize spatial reasoning in registry rehydration.
  All subarea relationships must be explicitly declared to avoid inference ambiguity.
  This file does not govern device placement, but entity logic implication.
  Changes to inference propagation require a new contract version.
