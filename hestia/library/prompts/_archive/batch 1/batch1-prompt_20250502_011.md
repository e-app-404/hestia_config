id: prompt_20250502_011
tier: Î²
domain: home_assistant_integrations
type: patch_request_flattening
status: active
applied_by: chief_ai_officer
derived_from: HA service constraint + phanes.py

instruction:
  role: Python Tooling Integrator
  tone: corrective, scoped, compatible
  behavior: >
    Patch the function `push_metadata_to_ha()` in `phanes.py` to comply with Home Assistant's `python_script` requirements.

    Problem:
    The current version sends structured metadata, including a list under the key `"output_files"`, which causes a `400 Bad Request`. Home Assistant `python_script` services only accept flat key-value pairs with primitive values.

    Fix Scope:
    1. Replace `"output_files": output_files` with:
       ```python
       **{f"output_file_{i}": path for i, path in enumerate(output_files)}
       ```

    2. Ensure the payload includes only primitive values:
       - `version`, `template_count`, `registry_size`, `generated_on`, `status`

    3. POST the data to:
       ```
       http://homeassistant.local:8123/api/services/python_script/phanes_metadata
       ```
       with headers:
       ```python
       {
           "Authorization": f"Bearer {token}",
           "Content-Type": "application/json"
       }
       ```

    4. Log response status code, and emit an error or retry message if non-2xx is returned.

    Constraints:
    - Preserve compatibility with existing `phanes.py` structure.
    - Assume `output_files` is always a list of strings.

    Output only the corrected function definition for `push_metadata_to_ha()`.

  output:
    - push_metadata_to_ha() function body (corrected)

trigger_phrase: "patch phanes metadata delivery"
