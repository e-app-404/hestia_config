---
# Consolidated Rehydration Package
# STRATEGOS::HA-BB8::SupervisorOnly-Hardening Session
# Generated: 2025-09-28
# Handoff Tag: HANDOFF::STRATEGOS::HA-BB8::2025-09-03T06:50Z-001
---

session_recap:
  session_label: STRATEGOS::HA-BB8::SupervisorOnly-Hardening
  trace_id: STRAT-HA-BB8-2025-09-03T06:50Z-001
  active_personas:
    - name: Strategos
      role: orchestration + governance
    - name: Copilot
      role: code generation + patch application
    - name: Operator
      role: HA host execution + evidence capture
  operational_mode:
    control_plane: single (run.sh supervises Python children)
    observability: Supervisor-only (ha CLI logs; no docker exec)
    heartbeat_interval_s: 15
    log_forwarding: enabled (select Python → stdout)
  escalation_context:
    trigger: container not visible via docker ps; diagnostics must avoid docker exec
    mitigation: DIAG-to-stdout, HEALTH_SUMMARY, file→stdout forwarder, Supervisor CLI runbooks
  last_validated_checkpoint:
    label: "Supervisor-only verification PASS"
    version: "2025.8.21.28"
    evidence: HEALTH_SUMMARY ticks, DIAG start/respawn lines, MQTT subscribe/connected lines
  governance_traits:
    adr_0001_commit_guard: enforced
    adr_0011_supervisor_only_ops: adopted
    single_control_plane: true
    s6_echo_service: down (by design)
    restart_policy: supervised in run.sh (unlimited unless flag present)
    diag_emission: stdout first, best-effort file append
  unresolved_blockers: []
  strategic_posture:
    intent: maintain Supervisor-only ops; expand functional checks (BLE/MQTT) as needed
    next_focus:
      - telemetry attestation (RTT trend)
      - optional backoff tuning + noise reduction in logs

artifacts:
  - path: addon/run.sh
    role: control_plane + diagnostics
    status: hardened
  - path: addon/config.yaml
    role: schema + UI options
    sha256: f0793e55fc81afc08ec50bfd7d03c7b932e1a5132a916917b735d93b149f9e8a
  - path: addon/services.d/ble_bridge/run
    role: s6 → run.sh delegate
  - path: addon/services.d/echo_responder/down
    role: guard (disable s6 echo longrun)
  - path: addon/bb8_core/main.py
    role: child process (bridge controller entry)
  - path: addon/bb8_core/echo_responder.py
    role: child process (MQTT echo loop)
  - path: addon/bb8_core/logging_setup.py
    role: centralized logging
  - path: docs/OPERATIONS_OVERVIEW.md
    role: ops runbook (Supervisor-only)
  - path: docs/SANITY_CHECKS.md
    role: verification checklist (Supervisor-only)
  - path: docs/TROUBLESHOOTING_RECIPES.md
    role: troubleshooting playbooks (Supervisor-only)
  - path: docs/ADR/ADR-0011-supervisor-only-ops.md
    role: decision record (governance)
  - path: /data/options.json
    role: runtime materialized options
  - path: /data/reports/ha_bb8_addon.log
    role: file log (best-effort append)
  - path: /tmp/bb8_heartbeat_main
    role: liveness (main)
  - path: /tmp/bb8_heartbeat_echo
    role: liveness (echo)
  - path: /tmp/bb8_restart_disabled
    role: manual halt flag (not used in Supervisor-only mode)
  # Host-provided reference packs (for broader context)
  - path: /mnt/data/architecture_doctrine.yaml
    role: governance/doctrine (reference)
  - path: /mnt/data/system_instruction.yaml
    role: orchestration baseline (reference)
  - path: /mnt/data/promachos_expansion_v3.yaml
    role: strategy pack (reference)
  - path: /mnt/data/dual_mode_xp_v1_250615.yaml
    role: ops profile (reference)
  - path: /mnt/data/prompt_tests.yaml
    role: validation scaffolding (reference)
  - path: /mnt/data/*_hass_config_backup.tar.gz
    role: HA backup archives (reference)

phases:
  - id: P1
    label: Root-cause analysis (restart loops)
    outputs: ["diagnostic hypotheses", "initial DIAG plan"]
    status: completed
  - id: P2
    label: Supervised runloop + DIAG (run.sh)
    outputs: ["RUNLOOP attempt", "child start/exit logs", "restart cap"]
    status: completed
  - id: P3
    label: Health checks + heartbeats
    outputs: ["/tmp/bb8_heartbeat_main", "/tmp/bb8_heartbeat_echo", "HEALTH_SUMMARY lines"]
    status: completed
  - id: P4
    label: S6 wiring (single control-plane)
    outputs: ["services.d/ble_bridge/run → run.sh", "services.d/echo_responder/down"]
    status: completed
  - id: P5
    label: Log-path normalization + resilience
    outputs: ["normalize_log_path()", "best-effort file append + stdout"]
    status: completed
  - id: P6
    label: Supervisor-only operations adoption
    outputs: ["stdout DIAG", "file→stdout forwarder", "15s HEALTH_SUMMARY"]
    status: completed
  - id: P7
    label: Documentation + governance
    outputs:
      - "docs/OPERATIONS_OVERVIEW.md (Supervisor-only)"
      - "docs/SANITY_CHECKS.md"
      - "docs/TROUBLESHOOTING_RECIPES.md"
      - "docs/ADR/ADR-0011-supervisor-only-ops.md"
    status: completed
  pending_copilot_instructions: []

memory_vars:
  last_valid_patch:
    summary: "Supervisor-only DIAG; 15s HEALTH_SUMMARY; file→stdout forwarder; single control-plane"
    version: "2025.8.21.28"
    files:
      - addon/run.sh
      - addon/config.yaml
      - addon/services.d/ble_bridge/run
      - addon/services.d/echo_responder/down
  last_decision_checkpoint:
    label: "Supervisor-only verification PASS"
    evidence:
      - DIAG lines present (entry, attempt, start, exit)
      - HEALTH_SUMMARY ticks over time
      - MQTT connected/subscribed lines in Supervisor logs
  clustered_entities:
    core:
      - run.sh (controller)
      - bb8_core.main (child)
      - bb8_core.echo_responder (child)
      - Supervisor (log surface)
      - Mosquitto (broker)
    count: 5
  inclusion_coverage:
    code: control-plane + both children + logging + s6 wiring
    docs: ops + sanity + troubleshooting + ADR
  semantic_summary: >
    HA-BB8 add-on hardened for environments where docker CLI is unavailable;
    all diagnostics exposed via Supervisor logs, single control-plane enforced,
    health and respawn evidenced without container access.
  open_validation_loops: []

rehydration_seed:
  session_label: STRATEGOS::HA-BB8::SupervisorOnly-Hardening
  trace_id: STRAT-HA-BB8-2025-09-03T06:50Z-001
  governance:
    adr:
      - ADR-0001 (commit guard)
      - ADR-0011 (Supervisor-only operations)
    guardrails:
      - no docker exec reliance
      - single control-plane via run.sh
      - DIAG to stdout + file best-effort
      - health summary at 15s cadence
  personas:
    - Strategos: orchestrate + enforce governance
    - Copilot: emit patches + runbooks; consume Operator outputs verbatim
    - Operator: execute HA CLI; return logs without truncation
  artifacts:
    primary:
      - addon/run.sh
      - addon/config.yaml
      - addon/services.d/ble_bridge/run
      - addon/services.d/echo_responder/down
      - addon/bb8_core/main.py
      - addon/bb8_core/echo_responder.py
    docs:
      - docs/OPERATIONS_OVERVIEW.md
      - docs/SANITY_CHECKS.md
      - docs/TROUBLESHOOTING_RECIPES.md
      - docs/ADR/ADR-0011-supervisor-only-ops.md
    runtime:
      - /data/options.json
      - /data/reports/ha_bb8_addon.log
      - /tmp/bb8_heartbeat_main
      - /tmp/bb8_heartbeat_echo
  last_checkpoint:
    version: "2025.8.21.28"
    status: "Supervisor-only verification PASS"
  memory_vars_ref:
    - last_valid_patch
    - last_decision_checkpoint
    - clustered_entities
    - inclusion_coverage
    - semantic_summary
  next_actions:
    - maintain 15s health summaries
    - optional: trend RTT telemetry
  resume_instructions:
    - "Consume Operator-provided HA logs + info outputs as ground truth."
    - "Operate within Supervisor-only constraints; do not request docker exec."
    - "If logs lack DIAG/HEALTH_SUMMARY, direct patch to run.sh only."