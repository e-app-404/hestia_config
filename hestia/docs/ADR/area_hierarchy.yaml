# AREA HIERARCHY & SPATIAL RELATIONSHIP CONTRACT
# Canonical definition of area → room → floor containment and propagation rules
# Status: DRAFT v1
# Last Updated: 2025-07-22
# PATCH-JOIN-CONTRACT-ROOM-MAPPING-V1

contract:
  id: area_relationships_contract
  version: 1.0
  author: Evert
  status: canonical_draft
  file_path: canonical/support/contracts/area_hierarchy.yaml

contract_metadata:
  last_validated: "2025-07-22"
  live_registry_consistency: partial
  coverage_percent: 100.0
  notes: |
    This contract is programmatically validated against live Home Assistant registry data. Coverage and consistency are updated on each validation run.

containment_graph:
  ground_floor:
    children: [downstairs, kitchen, laundry_room, living_room, powder_room]
  top_floor:
    children: [upstairs, sanctum]
  hallway:
    children: [downstairs, upstairs]
  downstairs:
    children: [entrance]
  sanctum:
    children: [bedroom, ensuite]
  bedroom:
    children: [bedroom, wardrobe, desk, hifi_area]
  hestia:
    children: [ha_addons, system_admin, virtual, services]
  home:
    children: [evert, general]
  system_admin:
    children: [network]
  network:
    children: [home_assistant, hubs_and_routers, nas]
  outside:
    children: [london]
  services:
    children: [alarm, calendar, notifications]
  ensuite: null
  kitchen: null
  laundry_room: null
  living_room: null
  entrance: null
  upstairs: null

nodes:
  - id: hallway
    type: area
    canonical_name: Hallway
    parents: [ground_floor, top_floor]
    container: ["area", "hallway", "Hallway"]
    devices: 6
    entities: 0
    services: 0
    tags: [transit, structural_connector]
  - id: kitchen
    type: area
    canonical_name: Kitchen
    parents: [ground_floor]
    container: ["area", "kitchen", "Kitchen"]
    devices: 18
    entities: 4
    services: 0
  - id: laundry_room
    type: area
    canonical_name: Laundry room
    parents: [ground_floor]
    container: ["area", "laundry_room", "Laundry room"]
    devices: 2
    entities: 0
    services: 0
  - id: living_room
    type: area
    canonical_name: Living Room
    parents: [ground_floor]
    container: ["area", "living_room", "Living Room"]
    devices: 25
    entities: 5
    services: 0
  - id: entrance
    type: subarea
    canonical_name: Entrance
    parents: [downstairs]
    container: ["area", "entrance", "Entrance"]
    devices: 5
    entities: 3
    services: 0
  - id: downstairs
    type: area
    canonical_name: Downstairs
    parents: [hallway]
    container: ["area", "downstairs", "Downstairs"]
    devices: 5
    entities: 4
    services: 0
  - id: upstairs
    type: area
    canonical_name: Upstairs
    parents: [hallway]
    container: ["area", "upstairs", "Upstairs"]
    devices: 5
    entities: 5
    services: 0
  - id: bedroom
    type: area
    canonical_name: "Evert's bedroom"
    parents: [sanctum_evert]
    container: ["area", "bedroom", "Bedroom main"]
    devices: 66
    entities: 7
    services: 0
  - id: bedroom_main
    type: subarea
    canonical_name: Bedroom
    parents: [bedroom]
    container: ["area", "bedroom_main", "Bedroom main"]
    devices: 0
    entities: 0
    services: 0
  - id: desk
    type: subarea
    canonical_name: Desk
    parents: [bedroom]
    container: ["area", "desk", "Desk"]
    devices: 20
    entities: 0
    services: 0
  - id: wardrobe
    type: subarea
    canonical_name: Wardrobe
    parents: [bedroom]
    container: ["area", "wardrobe", "Wardrobe"]
    devices: 4
    entities: 2
    services: 0
  - id: ensuite
    type: area
    canonical_name: Ensuite
    parents: [sanctum_evert]
    container: ["area", "ensuite", "Ensuite"]
    devices: 16
    entities: 4
    services: 0
  - id: evert
    type: person
    canonical_name: Evert
    parents: [outside]
    container: ["area", "evert", "Evert"]
    devices: 9
    entities: 3
    services: 1
  - id: calendar
    type: service
    canonical_name: Calendar
    parents: [services]
    container: ["area", "calendar", "Calendar"]
    devices: 0
    entities: 11
    services: 1
  - id: alarm
    type: service
    canonical_name: Alarm
    parents: [services]
    container: ["area", "alarm", "Alarm"]
    devices: 0
    entities: 7
    services: 1
  - id: notifications
    type: service
    canonical_name: Notifications
    parents: [services]
    container: ["area", "notifications", "Notifications"]
    devices: 0
    entities: 0
    services: 1

propagation_rules:
  motion:
    from_subarea_to_area: probable # e.g., desk → bedroom
    from_area_to_subarea: improbable # e.g., bedroom → desk
    from_area_to_container: probable # e.g., bedroom → sanctum_evert
    from_container_to_area: undefined
    transient_decay: true # motion loses confidence across boundaries
    decay_rate: 0.7 # relative confidence reduction per level
    tags: [decay, boundary, propagation]
  presence:
    from_subarea_to_area: possible
    from_area_to_subarea: rare
    from_area_to_container: possible
    from_container_to_area: unlikely
    memory: sticky # presence has higher retention than motion
    tags: [retention, propagation]
  occupancy:
    aggregate_method: weighted_sum
    weights:
      subarea: 0.6
      area: 1.0
      container: 0.4
    decay_profile:
      subarea_timeout: 2m
      area_timeout: 5m
      container_timeout: 10m
    tags: [aggregation, decay]
  graph:
    allow_cycles: false
    max_depth: 5
    transitive_inference: true
    tags: [graph, traversal]

output_contract:
  emit_to: canonical/joins/area_room_floor_hierarchy.json
  schema:
    - area_id: string
    - parent_room: string | null
    - floor_id: string
    - type: enum(area, subarea, floor, service)
    - inference_weight: float
    - contributes_to: list[string]
    - inferred_by: string | null

notes: |
  The purpose of this contract is to standardize spatial reasoning in registry rehydration.
  All subarea relationships must be explicitly declared to avoid inference ambiguity.
  This file does not govern device placement, but entity logic implication.
  Changes to inference propagation require a new contract version.
