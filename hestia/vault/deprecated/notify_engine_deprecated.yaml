# ══════════════════════════════════════════════════════════════════
# ⟫⟫ NOTIFY ENGINE  •  Unified Notification Delivery Script ◀
# ⟫⟫ script: notify_engine  •  HESTIA Notification Logic
# ⟫⟫ Tier: γ  •  Domain: notification  •  Created: 2025-08-05
# ⟫⟫ Last Updated: 2025-08-05
# ══════════════════════════════════════════════════════════════════

notify_engine:
  alias: "Unified Notification Engine"
  mode: queued
  sequence:
    - condition: or
      conditions:
        - condition: state
          entity_id: input_boolean.text_notifications
          state: "on"

    - variables:
        who_device: "{{ who | default('all') | lower }}"
        # Map possible `who` inputs to actual notify service names.
        notify_services:
          {
            "ipad": "notify.mobile_app_epad",
            "iPhone": "notify.mobile_app_ephone_uk",
            "iPhone_Spain": "notify.mobile_app_iphone11",
            "MacBook": "notify.mobile_app_macbook",
            "all": "notify.notify",
            "evert": "notify.notify",
            "persistent": "notify.persistent_notification",
            "send_message": "notify.send_message",
          }

    # Only proceed if the who_device is recognized
    - choose:
        - conditions: "{{ who_device in notify_services.keys() }}"
          sequence:
            - action: "{{ notify_services[who_device] }}"
              data:
                title: "{{ title | default('') }}"
                message: >
                  {{ value1 | default('') }}
                  {% if value2 is defined %}{{ '\n' + value2 }}{% endif %}
                  {% if value3 is defined %}{{ '\n' + value3 }}{% endif %}
                target: "{{ target_id | default('') }}"
                data:
                  subtitle: "{{ subtitle | default('') }}"
                  subject: "{{ subtitle | default('') }}"
                  attachment:
                    url: "{{ clickAction | default('') }}"
                    content-type: "{{ content_type | default('') }}"
                    hide-thumbnail: false
                  url: "{{ clickAction | default('') }}"
                  clickAction: "{{ clickAction | default('') }}"
                  apns_headers:
                    "apns-collapse-id": "{{ tag_id | default('') }}"
                  group: "{{ group | default('') }}"
                  tag: "{{ tag_id | default('') }}"
                  entity_id: "{{ camera_entity | default('') }}"
                  file: "{{ file | default('') }}"
                  caption: "{{ caption | default('') }}"
                  push:
                    category: "{{ ios_category | default('') }}"
                    sound: "{{ ios_sound | default('default') }}"
                    badge: "{{ ios_badge | default('') }}"
        # Fallback if not recognized
        - conditions: []
          sequence:
            - action: notify.notify
              data:
                title: "Notification Delivery Error"
                message: >
                  Notification for '{{ who_device }}' could not be delivered.
                  Please check device integration or spelling.
                data:
                  group: "notification_error"
# ------------------------------------------------------------------
# USAGE & ENGINE DETAILS (for maintainers)
#
# Hardened Notification Engine Script
#
# Key Improvements:
#   • Validation: Only sends to a known/allowed device, else fallback to notify.notify or logs error.
#   • Extensible: Easily add/remove supported devices.
#   • Supports group/individual targets based on who variable.
#   • Handles case where who is missing or unrecognized.
#   • Compatible with HA 2024.8+ action syntax.
#   • Allows for future expansion (Telegram, Discord, etc).
#
# How to Use:
#   When calling this script, specify:
#     • who: (ipad, ephone_uk, iphone11, macbook, all, etc)
#     • title:, value1:, value2:, value3: for message content
#     • Optional advanced fields as documented
#
#   Example usage:
#     - service: script.notify_engine
#       data:
#         who: iphone11
#         title: "Home Alert"
#         value1: "Garage door was left open."
#
# Key Hardenings:
#   • Only sends to recognized devices.
#   • Falls back and notifies on error.
#   • Supports all devices in your screenshot.
#   • Modular and ready for future expansion.
#   • Uses 2024.8+ action: syntax.
# ------------------------------------------------------------------
