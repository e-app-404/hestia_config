# ═══════════════════════════════════════════════════════════════
# ▶ LOGIC SENSOR: Presence Inference Fusion ◀
# Gamma-tier presence sensors using multimodal inference
# Loader: !include_dir_merge_list from entities/templates/logic/
# Tier: γ  •  Domain: logic  •  Created: 2025-06-12
# ═══════════════════════════════════════════════════════════════

- binary_sensor:
    #───────────────────────────────────────────────────────────────
    # ▼ GROUP: Room Presence Inference
    #───────────────────────────────────────────────────────────────
    - name: "Bedroom Presence (Gamma)"
      unique_id: bedroom_presence_gamma
      device_class: presence
      state: >
        {% from 'template.library.jinja' import evaluate_room_presence %}
        {{ evaluate_room_presence(
          'bedroom',
          'binary_sensor.bedroom_motion_recent_beta',
          ['binary_sensor.bedroom_occupancy_beta'],
          [
            'binary_sensor.in_bed_withings_inference_gamma',
            'binary_sensor.desk_presence_macbook_inference_gamma'
          ]
        ) }}
      attributes:
        tier: "γ"
        canonical_id: "bedroom_presence_γ"
        subsystem: hermes
        module: presence
        type: inference_fusion
        role: gamma_presence
        file: "/config/hestia/binary_sensors/gamma_presence_inference.yaml"
        origin: multimodal_presence_inference
        refactor_note: "Phase 3: Weighted presence inference with bed/desk contextual signals"
        description: "Multimodal presence inference for bedroom using motion, occupancy, and contextual signals."
        upstream_sources: >
          {{ [
            'binary_sensor.bedroom_motion_recent_beta',
            'binary_sensor.bedroom_occupancy_beta',
            'binary_sensor.in_bed_withings_inference_gamma',
            'binary_sensor.desk_presence_macbook_inference_gamma'
          ] | tojson }}
        inference_weights: "{{ { 'motion_recent': 40, 'occupancy': 30, 'inferred_bed': 25, 'inferred_desk': 25, 'device_tracker': 5 } | tojson }}"
        presence_threshold: 30
        room_areas: "bed, desk, wardrobe, main"
        aggregation_strategy: "weighted presence scoring with contextual inference"
        presence_sources: >
          {{ {
            'direct': ['motion_recent', 'occupancy'],
            'inferred': ['bed_presence', 'desk_presence'],
            'contextual': ['device_tracker']
          } | tojson }}
        downstream_consumers: >
          {{ [
            'binary_sensor.bedroom_presence_eta',
            'sensor.bedroom_presence_decay_delta'
          ] | tojson }}
        version: "3.1"
        created: "2025-06-05"
        last_updated: "2025-07-18"

    - name: "Kitchen Presence (Gamma)"
      unique_id: kitchen_presence_gamma
      device_class: presence
      state: >
        {% from 'template.library.jinja' import evaluate_room_presence %}
        {{ evaluate_room_presence(
          'kitchen',
          'binary_sensor.kitchen_motion_recent_beta',
          ['binary_sensor.kitchen_occupancy_beta'],
          []
        ) }}
      attributes:
        tier: "γ"
        canonical_id: "kitchen_presence_γ"
        subsystem: hermes
        module: presence
        type: inference_fusion
        role: gamma_presence
        file: "/config/hestia/binary_sensors/gamma_presence_inference.yaml"
        origin: multimodal_presence_inference
        refactor_note: "Phase 3: Motion and occupancy based presence inference"
        description: "Multimodal presence inference for kitchen using motion and occupancy."
        upstream_sources: >
          {{ [
            'binary_sensor.kitchen_motion_recent_beta',
            'binary_sensor.kitchen_occupancy_beta'
          ] | tojson }}
        inference_weights: >
          {{ {
            'motion_recent': 40,
            'occupancy': 30,
            'device_tracker': 5
          } | tojson }}
        presence_threshold: 30
        room_areas: "counters, dining_table, coffee_corner"
        aggregation_strategy: "weighted presence scoring with standard signals"
        presence_sources: >
          {{ {
            'direct': ['motion_recent', 'occupancy'],
            'inferred': [],
            'contextual': ['device_tracker']
          } | tojson }}
        downstream_consumers: >
          {{ [
            'binary_sensor.shared_space_presence_eta',
            'sensor.kitchen_presence_decay_delta'
          ] | tojson }}
        version: "3.0"
        last_updated: "2025-06-05"

    - name: "Living Room Presence (Gamma)"
      unique_id: living_room_presence_gamma
      device_class: presence
      delay_off:
        seconds: 300 # static value per HA schema
      state: >
        {% from 'template.library.jinja' import evaluate_room_presence %}
        {{ evaluate_room_presence(
          'living_room',
          'binary_sensor.living_room_motion_recent_beta',
          ['binary_sensor.living_room_occupancy_beta'],
          []
        ) }}
      attributes:
        tier: "γ"
        canonical_id: "living_room_presence_γ"
        subsystem: hermes
        module: presence
        type: inference_fusion
        role: gamma_presence
        file: "/config/hestia/binary_sensors/gamma_presence_inference.yaml"
        origin: multimodal_presence_inference
        refactor_note: "Phase 3: Context-aware timeout with entertainment/gaming mode detection"
        description: "Multimodal presence inference for living room with context-aware timeout."
        upstream_sources: >
          {{ [
            'binary_sensor.living_room_motion_recent_beta',
            'binary_sensor.living_room_occupancy_beta'
          ] | tojson }}
        inference_weights: >
          {{ {
            'motion_recent': 40,
            'occupancy': 30,
            'device_tracker': 5
          } | tojson }}
        presence_threshold: 30
        room_areas: "couch, windows, desk, liquor_cabinet"
        aggregation_strategy: "weighted presence scoring with context-aware timeout"
        context_timeout_logic: "{{ { 'entertainment_mode': '15min (projector playing)', 'gaming_mode': '12min (gaming console on)', 'default': '5min' } | tojson }}" # Jinja moved here for reference
        presence_sources: >
          {{ {
            'direct': ['motion_recent', 'occupancy'],
            'inferred': [],
            'contextual': ['device_tracker', 'media_state', 'gaming_state']
          } | tojson }}
        downstream_consumers: >
          {{ [
            'binary_sensor.shared_space_presence_eta',
            'sensor.living_room_presence_decay_delta'
          ] | tojson }}
        version: "3.1"
        last_updated: "2025-07-18"

    - name: "Ensuite Presence (Gamma)"
      unique_id: ensuite_presence_gamma
      device_class: presence
      delay_off:
        minutes: 10
      state: >
        {% from 'template.library.jinja' import evaluate_room_presence %}
        {{ evaluate_room_presence(
          'ensuite',
          'binary_sensor.ensuite_motion_recent_beta',
          ['binary_sensor.ensuite_occupancy_beta'],
          []
        ) }}
      attributes:
        tier: "γ"
        canonical_id: "ensuite_presence_γ"
        subsystem: hermes
        module: presence
        type: inference_fusion
        role: gamma_presence
        file: "/config/hestia/binary_sensors/gamma_presence_inference.yaml"
        origin: multimodal_presence_inference
        refactor_note: "Phase 3: Extended timeout for private bathroom usage patterns"
        description: "Multimodal presence inference for ensuite with extended timeout for privacy."
        upstream_sources: >
          {{ [
            'binary_sensor.ensuite_motion_recent_beta',
            'binary_sensor.ensuite_occupancy_beta'
          ] | tojson }}
        inference_weights: >
          {{ {
            'motion_recent': 40,
            'occupancy': 30,
            'device_tracker': 5
          } | tojson }}
        presence_threshold: 30
        room_areas: "main"
        timeout_behavior: "extended_for_privacy"
        aggregation_strategy: "weighted presence scoring with extended private space timeout"
        presence_sources: >
          {{ {
            'direct': ['motion_recent', 'occupancy'],
            'inferred': [],
            'contextual': ['device_tracker']
          } | tojson }}
        downstream_consumers: >
          {{ [
            'binary_sensor.private_space_presence_eta',
            'sensor.ensuite_presence_decay_delta'
          ] | tojson }}
        version: "3.0"
        last_updated: "2025-06-05"

    - name: "Hallway Downstairs Presence (Gamma)"
      unique_id: hallway_downstairs_presence_gamma
      device_class: presence
      state: >
        {% from 'template.library.jinja' import evaluate_room_presence %}
        {{ evaluate_room_presence(
          'hallway_downstairs',
          'binary_sensor.hallway_downstairs_motion_recent_beta',
          ['binary_sensor.hallway_downstairs_occupancy_beta'],
          ['binary_sensor.floor_activity_detected_gamma']
        ) }}
      attributes:
        tier: "γ"
        canonical_id: "hallway_downstairs_presence_γ"
        subsystem: hermes
        module: presence
        type: inference_fusion
        role: gamma_presence
        file: "/config/hestia/binary_sensors/gamma_presence_inference.yaml"
        origin: multimodal_presence_inference
        refactor_note: "Phase 3: Transition zone with floor activity inference"
        description: "Multimodal presence inference for hallway downstairs with floor activity detection."
        upstream_sources: >
          {{ [
            'binary_sensor.hallway_downstairs_motion_recent_beta',
            'binary_sensor.hallway_downstairs_occupancy_beta',
            'binary_sensor.floor_activity_detected_gamma'
          ] | tojson }}
        inference_weights: >
          {{ {
            'motion_recent': 40,
            'occupancy': 30,
            'floor_activity': 20,
            'device_tracker': 5
          } | tojson }}
        presence_threshold: 30
        room_areas: "main, entrance"
        aggregation_strategy: "weighted presence scoring with floor activity detection"
        presence_sources: >
          {{ {
            'direct': ['motion_recent', 'occupancy'],
            'inferred': ['floor_activity'],
            'contextual': ['device_tracker']
          } | tojson }}
        downstream_consumers: >
          {{ [
            'binary_sensor.downstairs_zone_presence_eta',
            'sensor.hallway_downstairs_presence_decay_delta'
          ] | tojson }}
        version: "3.0"
        last_updated: "2025-06-05"

    - name: "Hallway Upstairs Presence (Gamma)"
      unique_id: hallway_upstairs_presence_gamma
      device_class: presence
      state: >
        {% from 'template.library.jinja' import evaluate_room_presence %}
        {{ evaluate_room_presence(
          'hallway_upstairs',
          'binary_sensor.hallway_upstairs_motion_recent_beta',
          ['binary_sensor.hallway_upstairs_occupancy_beta'],
          ['binary_sensor.floor_activity_detected_gamma']
        ) }}
      attributes:
        tier: "γ"
        canonical_id: "hallway_upstairs_presence_γ"
        subsystem: hermes
        module: presence
        type: inference_fusion
        role: gamma_presence
        file: "/config/hestia/binary_sensors/gamma_presence_inference.yaml"
        origin: multimodal_presence_inference
        refactor_note: "Phase 3: Transition zone with floor activity inference"
        description: "Multimodal presence inference for hallway upstairs with floor activity detection."
        upstream_sources: >
          {{ [
            'binary_sensor.hallway_upstairs_motion_recent_beta',
            'binary_sensor.hallway_upstairs_occupancy_beta',
            'binary_sensor.floor_activity_detected_gamma'
          ] | tojson }}
        inference_weights: >
          {{ {
            'motion_recent': 40,
            'occupancy': 30,
            'floor_activity': 20,
            'device_tracker': 5
          } | tojson }}
        presence_threshold: 30
        room_areas: "main"
        aggregation_strategy: "weighted presence scoring with floor activity detection"
        presence_sources: >
          {{ {
            'direct': ['motion_recent', 'occupancy'],
            'inferred': ['floor_activity'],
            'contextual': ['device_tracker']
          } | tojson }}
        downstream_consumers: >
          {{ [
            'binary_sensor.upstairs_zone_presence_eta',
            'sensor.hallway_upstairs_presence_decay_delta'
          ] | tojson }}
        version: "3.0"
        last_updated: "2025-06-05"

    #───────────────────────────────────────────────────────────────
    # ▼ GROUP: Aggregated Zone & Home Synthesis
    #───────────────────────────────────────────────────────────────

    - name: "Shared Space Presence (Eta)"
      unique_id: shared_space_presence_eta
      device_class: presence
      state: >
        {% set presence_sources = [
          'binary_sensor.kitchen_presence_gamma',
          'binary_sensor.living_room_presence_gamma'
        ] %}
        {{ presence_sources | map('states') | select('eq', 'on') | list | count > 0 }}
      attributes:
        tier: "η"
        canonical_id: "shared_space_presence_η"
        subsystem: "hermes"
        module: "zone_presence"
        type: "zone_aggregation"
        role: "eta_presence"
        file: "/config/hestia/binary_sensors/eta_zone_presence.yaml"
        origin: "gamma_presence_aggregation"
        refactor_note: "Phase 3: Zone-level presence synthesis for shared living areas"
        description: "Zone-level presence synthesis for shared living areas."
        upstream_sources: >
          {{ [
            'binary_sensor.kitchen_presence_gamma',
            'binary_sensor.living_room_presence_gamma'
          ] | tojson }}
        zone_definition: "shared_living_spaces"
        rooms_included: >
          {{ ['kitchen', 'living_room'] | tojson }}
        aggregation_strategy: "OR logic across shared space γ-tier presence signals"
        zone_characteristics: >
          {{ {
            'type': 'common_areas',
            'floor': '1',
            'accessibility': 'high',
            'typical_activities': ['cooking', 'dining', 'entertainment', 'socializing']
          } | tojson }}
        active_rooms: >
          {% set presence_sources = [
            'binary_sensor.kitchen_presence_gamma',
            'binary_sensor.living_room_presence_gamma'
          ] %}
          {% set room_names = ['kitchen', 'living_room'] %}
          {% set active = [] %}
          {% for i in range(presence_sources | length) %}
            {% if states(presence_sources[i]) == 'on' %}
              {% set active = active + [room_names[i]] %}
            {% endif %}
          {% endfor %}
          {{ active | join(', ') if active else 'none' }}
        downstream_consumers: >
          {{ [
            'sensor.home_presence_confidence_delta',
            'binary_sensor.home_occupied_zeta'
          ] | tojson }}
        version: "3.0"
        last_updated: "2025-06-25"

    - name: "Private Space Presence (Eta)"
      unique_id: private_space_presence_eta
      device_class: presence
      state: >
        {% set presence_sources = [
          'binary_sensor.bedroom_presence_gamma',
          'binary_sensor.ensuite_presence_gamma'
        ] %}
        {{ presence_sources | map('states') | select('eq', 'on') | list | count > 0 }}
      attributes:
        tier: "η"
        canonical_id: "private_space_presence_η"
        subsystem: "hermes"
        module: "zone_presence"
        type: "zone_aggregation"
        role: "eta_presence"
        file: "/config/hestia/binary_sensors/eta_zone_presence.yaml"
        origin: "gamma_presence_aggregation"
        refactor_note: "Phase 3: Zone-level presence synthesis for private areas"
        description: "Zone-level presence synthesis for private areas."
        upstream_sources: >
          {{ [
            'binary_sensor.bedroom_presence_gamma',
            'binary_sensor.ensuite_presence_gamma'
          ] | tojson }}
        zone_definition: "private_personal_spaces"
        rooms_included: >
          {{ ['bedroom', 'ensuite'] | tojson }}
        aggregation_strategy: "OR logic across private space γ-tier presence signals"
        zone_characteristics: >
          {{ {
            'type': 'private_areas',
            'floor': '2',
            'accessibility': 'restricted',
            'typical_activities': ['sleeping', 'personal_care', 'work', 'relaxation']
          } | tojson }}
        active_rooms: >
          {% set presence_sources = [
            'binary_sensor.bedroom_presence_gamma',
            'binary_sensor.ensuite_presence_gamma'
          ] %}
          {% set room_names = ['bedroom', 'ensuite'] %}
          {% set active = [] %}
          {% for i in range(presence_sources | length) %}
            {% if states(presence_sources[i]) == 'on' %}
              {% set active = active + [room_names[i]] %}
            {% endif %}
          {% endfor %}
          {{ active | join(', ') if active else 'none' }}
        downstream_consumers: >
          {{ [
            'sensor.home_presence_confidence_delta',
            'binary_sensor.home_occupied_zeta'
          ] | tojson }}
        version: "3.0"
        last_updated: "2025-06-25"

    - name: "Upstairs Zone Presence (Eta)"
      unique_id: upstairs_zone_presence_eta
      device_class: presence
      state: >
        {% set presence_sources = [
          'binary_sensor.bedroom_presence_gamma',
          'binary_sensor.ensuite_presence_gamma',
          'binary_sensor.hallway_upstairs_presence_gamma'
        ] %}
        {{ presence_sources | map('states') | select('eq', 'on') | list | count > 0 }}
      attributes:
        tier: "η"
        canonical_id: "upstairs_zone_presence_η"
        subsystem: "hermes"
        module: "zone_presence"
        type: "zone_aggregation"
        role: "eta_presence"
        file: "/config/hestia/binary_sensors/eta_zone_presence.yaml"
        origin: "gamma_presence_aggregation"
        refactor_note: "Phase 3: Floor-based presence synthesis for upstairs areas"
        description: "Floor-based presence synthesis for upstairs areas."
        upstream_sources: >
          {{ [
            'binary_sensor.bedroom_presence_gamma',
            'binary_sensor.ensuite_presence_gamma',
            'binary_sensor.hallway_upstairs_presence_gamma'
          ] | tojson }}
        zone_definition: "upstairs_floor_areas"
        rooms_included: >
          {{ ['bedroom', 'ensuite', 'hallway_upstairs'] | tojson }}
        aggregation_strategy: "OR logic across upstairs γ-tier presence signals"
        zone_characteristics: >
          {{ {
            'type': 'floor_zone',
            'floor': '2',
            'accessibility': 'stairs_required',
            'typical_activities': ['sleeping', 'personal_care', 'work', 'transition']
          } | tojson }}
        active_rooms: >
          {% set presence_sources = [
            'binary_sensor.bedroom_presence_gamma',
            'binary_sensor.ensuite_presence_gamma',
            'binary_sensor.hallway_upstairs_presence_gamma'
          ] %}
          {% set room_names = ['bedroom', 'ensuite', 'hallway_upstairs'] %}
          {% set active = [] %}
          {% for i in range(presence_sources | length) %}
            {% if states(presence_sources[i]) == 'on' %}
              {% set active = active + [room_names[i]] %}
            {% endif %}
          {% endfor %}
          {{ active | join(', ') if active else 'none' }}
        downstream_consumers: >
          {{ [
            'sensor.home_presence_confidence_delta',
            'binary_sensor.home_occupied_zeta'
          ] | tojson }}
        version: "3.0"
        last_updated: "2025-06-25"

    - name: "Downstairs Zone Presence (Eta)"
      unique_id: downstairs_zone_presence_eta
      device_class: presence
      state: >
        {% set presence_sources = [
          'binary_sensor.kitchen_presence_gamma',
          'binary_sensor.living_room_presence_gamma',
          'binary_sensor.hallway_downstairs_presence_gamma'
        ] %}
        {{ presence_sources | map('states') | select('eq', 'on') | list | count > 0 }}
      attributes:
        tier: "η"
        canonical_id: "downstairs_zone_presence_η"
        subsystem: "hermes"
        module: "zone_presence"
        type: "zone_aggregation"
        role: "eta_presence"
        file: "/config/hestia/binary_sensors/eta_zone_presence.yaml"
        origin: "gamma_presence_aggregation"
        refactor_note: "Phase 3: Floor-based presence synthesis for downstairs areas"
        description: "Floor-based presence synthesis for downstairs areas."
        upstream_sources: >
          {{ [
            'binary_sensor.kitchen_presence_gamma',
            'binary_sensor.living_room_presence_gamma',
            'binary_sensor.hallway_downstairs_presence_gamma'
          ] | tojson }}
        zone_definition: "downstairs_floor_areas"
        rooms_included: >
          {{ ['kitchen', 'living_room', 'hallway_downstairs'] | tojson }}
        aggregation_strategy: "OR logic across downstairs γ-tier presence signals"
        zone_characteristics: >
          {{ {
            'type': 'floor_zone',
            'floor': '1',
            'accessibility': 'ground_level',
            'typical_activities': ['cooking', 'dining', 'entertainment', 'entry', 'transition']
          } | tojson }}
        active_rooms: >
          {% set presence_sources = [
            'binary_sensor.kitchen_presence_gamma',
            'binary_sensor.living_room_presence_gamma',
            'binary_sensor.hallway_downstairs_presence_gamma'
          ] %}
          {% set room_names = ['kitchen', 'living_room', 'hallway_downstairs'] %}
          {% set active = [] %}
          {% for i in range(presence_sources | length) %}
            {% if states(presence_sources[i]) == 'on' %}
              {% set active = active + [room_names[i]] %}
            {% endif %}
          {% endfor %}
          {{ active | join(', ') if active else 'none' }}
        downstream_consumers: >
          {{ [
            'sensor.home_presence_confidence_delta',
            'binary_sensor.home_occupied_zeta'
          ] | tojson }}
        version: "3.0"
        last_updated: "2025-06-25"

    - name: "Home Presence Synthesis (Eta)"
      unique_id: home_presence_synthesis_eta
      device_class: presence
      state: >
        {% set zone_sources = [
          'binary_sensor.shared_space_presence_eta',
          'binary_sensor.private_space_presence_eta',
          'binary_sensor.upstairs_zone_presence_eta',
          'binary_sensor.downstairs_zone_presence_eta'
        ] %}
        {{ zone_sources | map('states') | select('eq', 'on') | list | count > 0 }}
      attributes:
        tier: "η"
        canonical_id: "home_presence_synthesis_η"
        subsystem: "hermes"
        module: "zone_presence"
        type: "home_synthesis"
        role: "eta_presence"
        file: "/config/hestia/binary_sensors/eta_zone_presence.yaml"
        origin: "zone_presence_aggregation"
        refactor_note: "Phase 3: Ultimate home presence truth signal from all zone aggregations"
        description: "Ultimate home presence truth signal from all zone aggregations."
        upstream_sources: >
          {{ [
            'binary_sensor.shared_space_presence_eta',
            'binary_sensor.private_space_presence_eta',
            'binary_sensor.upstairs_zone_presence_eta',
            'binary_sensor.downstairs_zone_presence_eta'
          ] | tojson }}
        zone_definition: "whole_home_presence"
        zones_included: "shared_space, private_space, upstairs, downstairs"
        aggregation_strategy: "OR logic across all zone η-tier presence signals"
        zone_characteristics: >
          {{ {
            'type': 'whole_home',
            'floors': ['1', '2'],
            'accessibility': 'complete',
            'coverage': 'comprehensive_multi_zone'
          } | tojson }}
        active_zones: >
          {% set zone_sources = [
            'binary_sensor.shared_space_presence_eta',
            'binary_sensor.private_space_presence_eta',
            'binary_sensor.upstairs_zone_presence_eta',
            'binary_sensor.downstairs_zone_presence_eta'
          ] %}
          {% set zone_names = ['shared_space', 'private_space', 'upstairs', 'downstairs'] %}
          {% set active = [] %}
          {% for i in range(zone_sources | length) %}
            {% if states(zone_sources[i]) == 'on' %}
              {% set active = active + [zone_names[i]] %}
            {% endif %}
          {% endfor %}
          {{ active | join(', ') if active else 'none' }}
        downstream_consumers: >
          {{ [
            'binary_sensor.home_occupied_zeta',
            'automation.presence_based_lighting',
            'automation.security_arm_disarm'
          ] | tojson }}
        version: "3.0"
        last_updated: "2025-06-25"
# ═══════════════════════════════════════════════════════════════
# End of normalized gamma and eta presence logic sensors
# File validated: ✅ Home Assistant 2024.8+ syntax compatible
# ═══════════════════════════════════════════════════════════════
