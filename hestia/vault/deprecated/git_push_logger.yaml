#!/bin/bash

# ───────────────────────────────
# ▷ Script: git_push_logger.sh ◁
# Auto-commits and pushes HA config to DSM Git mirror
# Logs metadata and sends HA notifications
# ───────────────────────────────

LOGFILE="/config/hestia/diagnostics/logs/git_sync_push_events.json"
CONFIG_DIR="/config"
SECRETS_FILE="/config/secrets.yaml"
META_TMP="/tmp/meta_git_push.json"
BRANCH=$(git symbolic-ref --short HEAD 2>/dev/null || echo "master")
HA_URL="http://homeassistant.local:8123"  # or http://localhost:8123
NOTIFY_TITLE="Git Config Sync"

# Extract token from secrets.yaml using grep and sed
HA_TOKEN=$(grep 'your_home_assistant_long_lived_token:' "$SECRETS_FILE" | sed 's/.*: *//')

notify_hanotify_ha() {
  local message="$1"
  local title="$2"
  curl -s -X POST -H "Authorization: Bearer $HA_TOKEN" \
       -H "Content-Type: application/json" \
       -d "{\"title\": \"$title\", \"message\": \"$message\"}" \
       "$HA_URL/api/services/persistent_notification/create"
}

cd "$CONFIG_DIR" || {
  notify_ha "Failed to access $CONFIG_DIR" "$NOTIFY_TITLE"
  exit 1
}

if ! git diff-index --quiet HEAD; then
  TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
  HOSTNAME=$(hostname)
  META="{\"_meta\": {\"source\": \"git_push_logger.sh\", \"contract\": \"ha_config_sync\", \"timestamp\": \"$TIMESTAMP\", \"host\": \"$HOSTNAME\"}}"
  echo "$META" | jq '.' > "$META_TMP"

  git add . || {
    notify_ha "Git add failed during auto-sync at $TIMESTAMP" "$NOTIFY_TITLE"
    exit 2
  }

  git commit -m "Auto-sync: $TIMESTAMP" || {
    notify_ha "Git commit failed during auto-sync at $TIMESTAMP" "$NOTIFY_TITLE"
    exit 3
  }

  git push dsm "$BRANCH" || {
    notify_ha "Git push to '$BRANCH' failed at $TIMESTAMP" "$NOTIFY_TITLE"
    exit 4
  }

  if [ -f "$LOGFILE" ]; then
    cp "$LOGFILE" "$LOGFILE.bak"
  fi

  if [ -f "$LOGFILE" ]; then
    jq --argfile input "$META_TMP" '. += [$input]' "$LOGFILE" > "$LOGFILE.tmp" && mv "$LOGFILE.tmp" "$LOGFILE"
  else
    echo "[$META]" > "$LOGFILE"
  fi

  notify_ha "Git config successfully pushed to '$BRANCH' at $TIMESTAMP." "$NOTIFY_TITLE"
else
  echo "No changes to commit."
fi
