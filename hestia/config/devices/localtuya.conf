# ═══════════════════════════════════════════════════════════════
# ▶ TUYA / LOCALTUYA CONTEXT SEED ◀
# Local control of Tuya bulbs & dehumidifier (DP maps, HA entities)
# File: tuya.localtuya.context.yaml
# Domain: lighting, climate  •  Generated: 2025-09-05
# ═══════════════════════════════════════════════════════════════
tuya_local:
  _meta:
    title: "LocalTuya Configuration & Reference"
    created: "2025-09-05T00:00:00Z"
    last_updated: "2025-09-05T00:00:00Z"
    purpose: "Single-source-of-truth for device IDs, DP maps, and HA entity bindings."
    version: "1.0"

  # ────────────────────────────────────────────────────────────
  # INVENTORY (devices, IPs, keys, status)
  # ────────────────────────────────────────────────────────────
  inventory:
    - name: ensuite_accent_alpha_local
      kind: light
      product: "Enshine GU10 Smart Bulb"
      category: dj
      device_id: "bf6e0fc9863c8c666dan2c"
      ip: "192.168.0.241"
      local_key: "<stored-by-LocalTuya-config-flow>"
      status: active
      notes: "Configured and working; color + CCT supported."

    - name: laundry_ceiling_alpha_local
      kind: light
      product: "Enshine GU10 Smart Bulb"
      category: dj
      device_id: "bfd6a994377ced5769av0i"
      ip: "192.168.0.189"
      local_key: "<stored-by-LocalTuya-config-flow>"
      status: active
      notes: "Configured like ensuite_accent_alpha_local."

    - name: bedroom_probreeze_dehumidifier_alpha_local
      kind: dehumidifier
      product: "PB-D-18 OmniDry 12L Dehumidifier"
      category: cs
      device_id: "bfc078b00c8b86f6e3ta5d"
      ip: "192.168.0.186"
      local_key: "<stored-by-LocalTuya-config-flow>"
      status: active
      notes: "All core DPs mapped (power, target %, fan, temp/humidity, ionizer, etc.)."

    - name: ensuite_main_alpha_local
      kind: light
      product: "LVWIT Smart Light"
      category: dj
      device_id: "bf040717144f9b6400q4qy"
      ip: "<TBD>"
      local_key: "<TBD>"
      status: pending
      notes: >
        Not discovered by LocalTuya during last pass. Two unknown Tuya IDs were seen
        (bfbbe3cf5b05cffc84f8o2, 5317500710521cf34d4b). Likely paired under a different
        app/home or stale cache. Resolve by re-linking app account in Tuya cloud project,
        confirming the device lives in the same account/home, and re-running the
        LocalTuya discovery with the bulb powered.

  # ────────────────────────────────────────────────────────────
  # DP LEGEND (per product category)
  # ────────────────────────────────────────────────────────────
  dp_legend:
    dj: # RGB+CCT bulbs (Template v6.x)
      "20": switch_led (bool)
      "21": work_mode (enum: white|colour|scene|music)
      "22": bright_value / bright_value_v2 (int 10..1000)
      "23": temp_value / temp_value_v2     (int 0..1000)
      "24": colour_data / colour_data_v2   (packed HSV)
      "25": scene_data / scene_data_v2
      "26": countdown_1 (seconds)
      "34": do_not_disturb (bool)
      "41": remote_switch (bool)                 # present on some models
    cs:  # Dehumidifier
      "1":  switch (power)
      "2":  dehumidify_set_value (30..80 step 5)
      "4":  fan_speed_enum (low|high)
      "5":  mode (e.g., Auto)
      "6":  humidity_indoor (value; %)
      "7":  temp_indoor (value; °C/°F)
      "10": anion (ionizer) (bool)
      "16": child_lock (bool)
      "17": countdown_set (enum cancel|1h|2h|3h)
      "19": fault (bitmap)
      "20": filter_reset (bool; momentary)
      "23": filter_life (value; vendor-defined)
      "24": temp_unit_convert (enum c|f)
      "28": runtime_total_reset (bool; momentary)
      "102": client_id (ignore)
      "104": type_of_equipment (ignore)

  # ────────────────────────────────────────────────────────────
  # HA ENTITY BINDINGS (as created in LocalTuya)
  # ────────────────────────────────────────────────────────────
  ha_entities:
    ensuite_accent_alpha_local:
      light:
        id: 20
        brightness: 22
        color_temp: 23
        hs_color: 24
        color_mode: 21
        temp_min_kelvin: 2700
        temp_max_kelvin: 6500
        extras:
          scene_id: 25
          dnd_switch_id: 34   # optional
          remote_switch_id: 41 # optional
    laundry_ceiling_alpha_local:
      light:
        id: 20
        brightness: 22
        color_temp: 23
        hs_color: 24
        color_mode: 21
        temp_min_kelvin: 2700
        temp_max_kelvin: 6500
        extras:
          scene_id: 25
          dnd_switch_id: 34
          remote_switch_id: 41
    bedroom_probreeze_dehumidifier_alpha_local:
      switch_power:
        id: 1
        entity_id: switch.bedroom_dehumidifier_probreeze_power
      number_target_humidity:
        id: 2
        min: 30
        max: 80
        step: 5
        entity_id: number.bedroom_dehumidifier_target_humidity
      select_fan_speed:
        id: 4
        options: [low, high]
        entity_id: select.bedroom_dehumidifier_fan_speed
      select_mode:
        id: 5
        options: [Auto] # current
        entity_id: select.bedroom_dehumidifier_mode
      sensor_humidity:
        id: 6
        unit: "%"
        device_class: humidity
        state_class: measurement
        entity_id: sensor.bedroom_dehumidifier_humidity
      sensor_temperature:
        id: 7
        unit: "°C"
        device_class: temperature
        state_class: measurement
        entity_id: sensor.bedroom_dehumidifier_temperature
      switch_ionizer:
        id: 10
        entity_id: switch.bedroom_dehumidifier_ionizer
      switch_child_lock:
        id: 16
        entity_id: switch.bedroom_dehumidifier_child_lock
      select_countdown:
        id: 17
        options: [cancel, 1h, 2h, 3h]
        entity_id: select.bedroom_dehumidifier_timer
      sensor_fault_raw:
        id: 19
        entity_id: sensor.bedroom_dehumidifier_fault_code
      switch_filter_reset_momentary:
        id: 20
        restore_last_value: false
        entity_id: switch.bedroom_dehumidifier_filter_reset
      sensor_filter_life_raw:
        id: 23
        entity_id: sensor.bedroom_dehumidifier_filter_life_raw
      select_temp_unit:
        id: 24
        options: [c, f]
        entity_id: select.bedroom_dehumidifier_temp_unit
      switch_runtime_reset_momentary:
        id: 28
        restore_last_value: false
        entity_id: switch.bedroom_dehumidifier_runtime_reset

  # ────────────────────────────────────────────────────────────
  # SUPPORTING YAML (templates/automations)
  # ────────────────────────────────────────────────────────────
  yaml_snippets:
    template_binary_sensors: |
      template:
        - binary_sensor:
            - name: "Bedroom Dehumidifier Fault"
              unique_id: bedroom_dehumidifier_fault_active
              device_class: problem
              state: >
                {{ (states('sensor.bedroom_dehumidifier_fault_code') | int(0)) != 0 }}
              attributes:
                raw_code: "{{ states('sensor.bedroom_dehumidifier_fault_code') }}"
    momentary_switch_auto_off: |
      automation:
        - alias: "Dehumidifier filter reset → auto off"
          trigger:
            - platform: state
              entity_id: switch.bedroom_dehumidifier_filter_reset
              to: "on"
          action:
            - delay: "00:00:02"
            - service: switch.turn_off
              target:
                entity_id: switch.bedroom_dehumidifier_filter_reset

        - alias: "Dehumidifier runtime reset → auto off"
          trigger:
            - platform: state
              entity_id: switch.bedroom_dehumidifier_runtime_reset
              to: "on"
          action:
            - delay: "00:00:02"
            - service: switch.turn_off
              target:
                entity_id: switch.bedroom_dehumidifier_runtime_reset

  # ────────────────────────────────────────────────────────────
  # CONFIG FLOW (quick reference)
  # ────────────────────────────────────────────────────────────
  setup_guide:
    prerequisites:
      - "Tuya IoT project linked to the same app account/home as the devices."
      - "Devices placed on static/DHCP-reserved IPs."
    steps:
      - "Add Integration → LocalTuya."
      - "Pick device by IP (LocalTuya fetches device_id/local_key via the cloud link)."
      - "Add entities in this order:"
      - "  For bulbs: light (20/22/23/24 + 21; set 2700–6500 K)."
      - "  Extras (optional): scene (25), DND (34), remote_switch (41)."
      - "  For dehumidifier: power(1), target%(2), fan(4), mode(5), humidity(6), temp(7), ionizer(10), child_lock(16), timer(17), fault(19 sensor), filter_reset(20), filter_life(23), temp_unit(24), runtime_reset(28)."
      - "Create the two auto-off automations for the maintenance toggles."
      - "Create the problem binary_sensor from fault code."

  # ────────────────────────────────────────────────────────────
  # TROUBLESHOOTING & KNOWN ISSUES
  # ────────────────────────────────────────────────────────────
  troubleshooting:
    discovery_mismatch:
      symptom: "Bulb present in Tuya Cloud but not offered by LocalTuya discovery."
      likely_causes:
        - "Device tied to a different Tuya app/home or different cloud project."
        - "Bulb on a different VLAN/subnet or powered off during discovery."
        - "Stale LocalTuya cache; HA needs a restart."
      fixes:
        - "In Tuya IoT Project → Link Devices by App Account; confirm bulb is listed."
        - "Power-cycle bulb, ensure it’s on the main LAN, rerun LocalTuya discovery."
        - "Restart Home Assistant, retry."
    one_shot_buttons:
      note: "LocalTuya doesn’t have a native Button type; use Switch + auto-off automation."
    scaling:
      rule: "All reported values above use scaling factor 1 (no ×10) unless future firmware dictates otherwise."
    dp_102_104:
      note: "Housekeeping fields (client/equipment); ignore in HA."

  # ────────────────────────────────────────────────────────────
  # SANITY CHECKS (manual)
  # ────────────────────────────────────────────────────────────
  sanity_checks:
    - "Toggle switch.bedroom_dehumidifier_probreeze_power → unit powers on/off."
    - "Adjust number.bedroom_dehumidifier_target_humidity → device target updates on panel."
    - "Change select.bedroom_dehumidifier_temp_unit to 'f' → temperature sensor flips to °F."
    - "Turn on switch.bedroom_dehumidifier_filter_reset → auto-off after ~2s, device acknowledges."
    - "Bulbs: set color_temp extremes (2700/6500 K) and HS colors via light.* entities."

  # ────────────────────────────────────────────────────────────
  # SECURITY / STORAGE
  # ────────────────────────────────────────────────────────────
  security:
    local_keys_source: "Fetched during LocalTuya config (from linked Tuya Cloud)."
    storage:
      - "Hidden in HA storage; not committed to git."
    recommendation:
      - "Keep devices on reserved IPs; segment IoT if desired."
      - "Re-run discovery after re-linking app accounts or moving devices across homes."

home_assistant_components:
  integrations:
    - localtuya
  entities_created:
    lights:
      - light.ensuite_accent_alpha_local
      - light.laundry_ceiling_alpha_local
      # pending
      - light.ensuite_main_alpha_local
    dehumidifier:
      - switch.bedroom_dehumidifier_probreeze_power
      - number.bedroom_dehumidifier_target_humidity
      - select.bedroom_dehumidifier_fan_speed
      - select.bedroom_dehumidifier_mode
      - sensor.bedroom_dehumidifier_humidity
      - sensor.bedroom_dehumidifier_temperature
      - switch.bedroom_dehumidifier_ionizer
      - switch.bedroom_dehumidifier_child_lock
      - select.bedroom_dehumidifier_timer
      - sensor.bedroom_dehumidifier_fault_code
      - switch.bedroom_dehumidifier_filter_reset
      - sensor.bedroom_dehumidifier_filter_life_raw
      - select.bedroom_dehumidifier_temp_unit
      - switch.bedroom_dehumidifier_runtime_reset
    helpers_and_templates:
      - binary_sensor.bedroom_dehumidifier_fault
      - automations:
          - automation.dehumidifier_filter_reset_auto_off
          - automation.dehumidifier_runtime_reset_auto_off

curl_requests:
    - id: bfc078b00c8b86f6e3ta5d
      result: |
        {"result":{"properties":[{"code":"switch","custom_name":"","dp_id":1,"time":1757035932322,"type":"bool","value":false},{"code":"dehumidify_set_value","custom_name":"","dp_id":2,"time":1755912881062,"type":"value","value":40},{"code":"fan_speed_enum","custom_name":"","dp_id":4,"time":1755912865637,"type":"enum","value":"low"},{"code":"mode","custom_name":"","dp_id":5,"time":1749737781688,"type":"enum","value":"Auto"},{"code":"humidity_indoor","custom_name":"","dp_id":6,"time":1757037596607,"type":"value","value":66},{"code":"temp_indoor","custom_name":"","dp_id":7,"time":1757037607763,"type":"value","value":23},{"code":"anion","custom_name":"","dp_id":10,"time":1757035663028,"type":"bool","value":true},{"code":"child_lock","custom_name":"","dp_id":16,"time":1757037370067,"type":"bool","value":false},{"code":"countdown_set","custom_name":"","dp_id":17,"time":1748437545489,"type":"enum","value":"cancel"},{"code":"fault","custom_name":"","dp_id":19,"time":1756944013278,"type":"bitmap","value":1},{"code":"filter_reset","custom_name":"","dp_id":20,"time":1757035949534,"type":"bool","value":false},{"code":"filter_life","custom_name":"","dp_id":23,"time":1728556671528,"type":"value","value":0},{"code":"temp_unit_convert","custom_name":"","dp_id":24,"time":1748437543673,"type":"enum","value":"c"},{"code":"runtime_total_reset","custom_name":"","dp_id":28,"time":1757035932642,"type":"bool","value":false},{"code":"client_id","custom_name":"","dp_id":102,"time":1748437543748,"type":"value","value":0},{"code":"type_of_equipment","custom_name":"","dp_id":104,"time":1748437543838,"type":"value","value":4}]},"success":true,"t":1757037654171,"tid":"27d53be989fc11f08e5dda57e8f5d0ed"}%
    - id: bf6e0fc9863c8c666dan2c
      result: |
        {"result":{"properties":[{"code":"switch_led","custom_name":"","dp_id":20,"time":1757033863734,"type":"bool","value":false},{"code":"work_mode","custom_name":"","dp_id":21,"time":1756968031483,"type":"enum","value":"colour"},{"code":"bright_value","custom_name":"","dp_id":22,"time":1756666572373,"type":"value","value":328},{"code":"temp_value","custom_name":"","dp_id":23,"time":1756666572373,"type":"value","value":0},{"code":"colour_data","custom_name":"","dp_id":24,"time":1756968031483,"type":"string","value":"001b018803e8"},{"code":"scene_data","custom_name":"","dp_id":25,"time":1756666572373,"type":"string","value":"000e0d0000000000000000c80000"},{"code":"countdown","custom_name":"","dp_id":26,"time":1756666572373,"type":"value","value":0},{"code":"music_data","custom_name":"","dp_id":27,"time":1739509221271,"type":"string","value":""},{"code":"control_data","custom_name":"","dp_id":28,"time":1739509221271,"type":"string","value":""},{"code":"debug_data","custom_name":"","dp_id":29,"time":1739509221271,"type":"string","value":""},{"code":"rhythm_mode","custom_name":"","dp_id":30,"time":1756958550678,"type":"raw","value":"AAAAAAA="},{"code":"sleep_mode","custom_name":"","dp_id":31,"time":1756958550818,"type":"raw","value":"AAA="},{"code":"wakeup_mode","custom_name":"","dp_id":32,"time":1756958550889,"type":"raw","value":"AAA="},{"code":"power_memory","custom_name":"","dp_id":33,"time":1756958551304,"type":"raw","value":"AAEBSwLSA+gBSAAA"},{"code":"do_not_disturb","custom_name":"","dp_id":34,"time":1756666572373,"type":"bool","value":false},{"code":"remote_switch","custom_name":"","dp_id":41,"time":1756666572379,"type":"bool","value":true},{"code":"cycle_timing","custom_name":"","dp_id":209,"time":1756958551195,"type":"raw","value":"AAAA"},{"code":"random_timing","custom_name":"","dp_id":210,"time":1756958551088,"type":"raw","value":"AAAA"}]},"success":true,"t":1757039068159,"tid":"729ecef389ff11f0a25e9ed280a40f39"}
# ═══════════════════════════════════════════════════════════════

# addendum 2025-09-16: Re-integration under new Tuya IoT account:

Run in terminal tool: `tuya-cli wizard`

Provide the following data:
The API key from tuya.com: secret! tuya_iot_access_ID_Client_ID
? The API secret from tuya.com secret! tuya_iot_access_secret
? Provide a 'virtual ID' of a device currently registered in the app: `bfc078b00c8b86f6e3ta5d`

[
  {
    name: 'Cosmic Globe',
    id: 'bf6e0fc9863c8c666dan2c',
    key: 'Nt6;{B?9?GjEzyMv'
  },
  {
    name: 'laundry_ceiling',
    id: 'bfd6a994377ced5769av0i',
    key: 'nPw(t[m+wq!V*#7;'
  },
  {
    name: 'ProBreeze Dehumidifier',
    id: 'bfc078b00c8b86f6e3ta5d',
    key: '6K-e9Wn$k]khse-0'
  },
  {
    name: 'Ensuite Lamp',
    id: 'bf040717144f9b6400q4qy',
    key: 'z<IxAZ-i&#.CnJ1Z'
  }
]

# then run (example) to register the devices:
tuya-cli link --api-key secret! tuya_iot_access_ID_Client_ID --api-secret secret! tuya_iot_access_secret --schema clap12 --ssid Aethernet_IoT --password secret! wifi_1_pass --region eu