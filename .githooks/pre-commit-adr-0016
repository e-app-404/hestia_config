#!/usr/bin/env bash
# Pre-commit hook: ADR-0016 Path Expansion Compliance
# Prevents commits that introduce Python Path() with tilde but no .expanduser()

set -e

# Only check Python files being committed
PYTHON_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep '\.py$' || true)

if [ -z "$PYTHON_FILES" ]; then
    # No Python files being committed
    exit 0
fi

echo "üîç Checking Python files for ADR-0016 path expansion compliance..."

VIOLATIONS=0

for file in $PYTHON_FILES; do
    if [ -f "$file" ]; then
        # Check staged content for violations
        SINGLE_VIOLATIONS=$(git show ":$file" | grep -n "Path('~[^']*')" | grep -v "\.expanduser()" || true)
        DOUBLE_VIOLATIONS=$(git show ":$file" | grep -n 'Path("~[^"]*")' | grep -v "\.expanduser()" || true)
        
        if [ -n "$SINGLE_VIOLATIONS" ] || [ -n "$DOUBLE_VIOLATIONS" ]; then
            echo "‚ùå ADR-0016 VIOLATION in $file:"
            [ -n "$SINGLE_VIOLATIONS" ] && echo "$SINGLE_VIOLATIONS"
            [ -n "$DOUBLE_VIOLATIONS" ] && echo "$DOUBLE_VIOLATIONS"
            VIOLATIONS=1
        fi
    fi
done

if [ $VIOLATIONS -eq 1 ]; then
    echo ""
    echo "üí° Fix: Add .expanduser() to Path() calls with tilde:"
    echo "   Path('~/path') ‚Üí Path('~/path').expanduser()"
    echo ""
    echo "Or use: Path(os.path.expanduser('~/path'))"
    echo ""
    echo "Run: make adr-0016-validate to check all files"
    exit 1
fi

echo "‚úÖ ADR-0016 compliance check passed"
exit 0